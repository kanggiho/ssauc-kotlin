<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout.html">
<head>
    <meta charset="UTF-8">
    <title>íŒë§¤ ë‚´ì—­ ìƒì„¸</title>
    <!-- í•„ìš”í•œ CSS, JS, CDN ë“± -->
    <link rel="stylesheet" href="/css/mypage.css">
    <script src="/js/smartApiCodes.js"></script>
    <style>
        /* ìºëŸ¬ì…€ ì „ì²´ ì˜ì—­ ë° ê° ìŠ¬ë¼ì´ë“œì˜ ê³ ì • ë†’ì´ ì„¤ì • */
        .carousel-inner,
        .carousel-item {
            height: 300px;
            width: 300px;
            position: relative;
            margin: 0 auto;
        }
        /* ìºëŸ¬ì…€ ìŠ¬ë¼ì´ë“œ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .carousel-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            width: 1.5rem;
            height: 1.5rem;
        }

        .carousel-control-prev,
        .carousel-control-next {
            width: 30px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            position: absolute;
        }

        .carousel-control-prev {
            left: 0;
        }

        .carousel-control-next {
            right: 0;
        }

        .tracking-number {
            margin-top: 16px;
        }

        .card-body {
            padding-bottom: 0 !important;
        }
    </style>
</head>
<body>
<div class="container2" layout:fragment="content">
        <!-- ì™¼ìª½ Sidebar (mypage ê·¸ëŒ€ë¡œ) -->
        <div class="sidebar" th:replace="~{mypage/mypage :: sidebar}"></div>
        <!-- ì˜¤ë¥¸ìª½ ë©”ì¸ ì»¨í…ì¸  -->
        <div class="main2">
            <h2 class="mb-4">íŒë§¤ ìƒì„¸ ë‚´ì—­</h2>

            <!-- Section 1: ì§ê±°ë˜ ë° ë°°ì†¡ ì¥ì†Œ (Product Info) -->
            <div class="card mb-4">
                <div class="card-header fw-bold">íŒë§¤ ìƒí’ˆ ì •ë³´</div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <!-- ì™¼ìª½: ìƒí’ˆ ì •ë³´ -->
                        <div class="col-md-7">
                            <p>
                                <strong>ìƒí’ˆ ì´ë¦„:</strong>
                                <span class="productBid"
                                      th:text="${soldDetail.productName}"
                                      th:onclick="|location.href='/bid/bid?productId=' + ${soldDetail.productId}|">
                                </span>
                            </p>
                            <p><strong>ê²½ë§¤ ì‹œì‘ê°€:</strong> <span th:text="${soldDetail.startPrice}">10000</span></p>
                            <p><strong>ë“±ë¡ ì‹œê°„:</strong> <span
                                    th:text="${#temporals.format(soldDetail.createdAt, 'yyyy-MM-dd HH:mm:ss')}">2025-02-05 14:30:00</span>
                            </p>
                            <p><strong>ê±°ë˜ ë°©ì‹:</strong> <span
                                    th:text="${soldDetail.dealType == 0 ? 'ğŸ§‘ğŸ» ì§ê±°ë˜' : (soldDetail.dealType == 1 ? 'ğŸšš íƒë°°ê±°ë˜' : 'ğŸ§‘ğŸ»ğŸšš ì§ê±°ë˜, íƒë°°ê±°ë˜')}">ê±°ë˜ ë°©ì‹</span>
                            </p>
                            <hr>
                            <p>
                                <strong>êµ¬ë§¤ì:</strong>
                                <span class="productBid"
                                      th:text="${soldDetail.buyerName}"
                                      th:attr="data-sellername=${soldDetail.buyerName}"
                                      onclick="handleSellerClick(event)">user</span>
                            </p>
                            <p><strong>íŒë§¤ê°€:</strong> <span th:text="${soldDetail.totalPrice}">50,000 ì›</span></p>
                            <p><strong>íŒë§¤ ì‹œê°„:</strong> <span
                                    th:text="${#temporals.format(soldDetail.orderDate, 'yyyy-MM-dd HH:mm:ss')}">2025-02-06 16:45:00</span>
                            </p>
                            <p><strong>ê±°ë˜ ì™„ë£Œ ì‹œê°„:</strong> <span
                                    th:text="${#temporals.format(soldDetail.completedDate, 'yyyy-MM-dd HH:mm:ss')}">2025-02-06 17:00:00</span>
                            </p>
                        </div>
                        <!-- ì˜¤ë¥¸ìª½: ìƒí’ˆ ì´ë¯¸ì§€ Carousel -->
                        <div class="col-md-5">
                            <div id="carouselSold" class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner">
                                    <div th:each="image, iterStat : ${carouselImages}"
                                         class="carousel-item"
                                         th:classappend="${iterStat.index == 0} ? ' active' : ''">
                                        <img th:src="@{${image.url}}" class="d-block w-100" th:alt="${image.alt}"/>
                                    </div>
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#carouselSold"
                                        data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">ì´ì „</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#carouselSold"
                                        data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">ë‹¤ìŒ</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: ë°°ì†¡ì§€, ìˆ˜ë ¹ì¸ ì •ë³´ ë° ìš´ì†¡ì¥ ë“±ë¡ -->
            <div class="card mb-4">
                <div class="card-header fw-bold">ë°°ì†¡ ìš”ì²­ ì •ë³´</div>
                <div class="card-body">
                    <p><strong>ìˆ˜ë ¹ì¸ ì´ë¦„:</strong> <span th:text="${soldDetail.recipientName}">í™ê¸¸ë™</span></p>
                    <p><strong>ìˆ˜ë ¹ì¸ ì—°ë½ì²˜:</strong> <span th:text="${soldDetail.recipientPhone}">010-1234-5678</span></p>
                    <p><strong>ìš°í¸ë²ˆí˜¸:</strong> <span th:text="${soldDetail.postalCode}">12345</span></p>
                    <p><strong>ë°°ì†¡ ì£¼ì†Œ:</strong> <span th:text="${soldDetail.deliveryAddress}">ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123</span>
                    </p>
                    <!-- ìš´ì†¡ì¥ ë“±ë¡ ì˜ì—­ -->
                    <div class="tracking mt-3">
                        <span class="fw-bold">ìš´ì†¡ì¥ ì •ë³´ ë“±ë¡:</span>
                        <button class="btn btn-primary btn-sm" onclick="registerTracking()"
                                th:text="'ìš´ì†¡ì¥ ë“±ë¡'">
                            ìš´ì†¡ì¥ ë“±ë¡
                        </button>
                        <p class="tracking-number">
                            <strong>ë“±ë¡í•œ ìš´ì†¡ì¥ ì •ë³´:</strong>
                            <span id="trackingNo" th:attr="data-raw-tracking=${soldDetail.deliveryStatus}"></span>
                        </p>
                    </div>
                </div>
            </div>

        </div>
</div>

<!-- ë°°ì†¡ ìš´ì†¡ì¥ ë“±ë¡ ëª¨ë‹¬ HTML -->
<div class="modal fade" id="trackingModal" tabindex="-1" aria-labelledby="trackingModalLabel" aria-hidden="true" layout:fragment="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trackingModalLabel">ìš´ì†¡ì¥ ë“±ë¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">íƒë°°ì‚¬ ìœ í˜• ì„ íƒ:</label>
                    <div>
                        <button id="domesticBtn" type="button" class="btn btn-secondary">êµ­ë‚´ íƒë°°</button>
                        <button id="internationalBtn" type="button" class="btn btn-secondary">êµ­ì œ íƒë°°</button>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="courierSelect" class="form-label">íƒë°°ì‚¬ ì„ íƒ:</label>
                    <select id="courierSelect" class="form-select"></select>
                </div>
                <div class="mb-3">
                    <label for="trackingInput" class="form-label">ìš´ì†¡ì¥ ë²ˆí˜¸ ì…ë ¥:</label>
                    <input type="text" id="trackingInput" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveTrackingBtn" type="button" class="btn btn-primary">ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script layout:fragment="script" th:inline="javascript">

    document.addEventListener('DOMContentLoaded', function() {
        updateTrackingDisplay();
    });
    function updateTrackingDisplay() {
        const trackingSpan = document.getElementById('trackingNo');
        const rawTracking = trackingSpan.getAttribute('data-raw-tracking');
        if(rawTracking && rawTracking.includes('/')) {
            const parts = rawTracking.split('/');
            const code = parts[0];
            const number = parts[1];
            let courierName = '';
            // êµ­ë‚´ íƒë°°ì‚¬ ë°°ì—´ì—ì„œ ì½”ë“œ ê²€ìƒ‰
            domesticCouriers.some(function(courier) {
                if(courier.code === code) {
                    courierName = courier.name;
                    return true;
                }
                return false;
            });
            // êµ­ë‚´ì— ì—†ìœ¼ë©´ êµ­ì œ íƒë°°ì‚¬ ë°°ì—´ì—ì„œ ê²€ìƒ‰
            if(!courierName) {
                internationalCouriers.some(function(courier) {
                    if(courier.code === code) {
                        courierName = courier.name;
                        return true;
                    }
                    return false;
                });
            }
            if(courierName) {
                trackingSpan.textContent = 'íƒë°°ì‚¬: ' + courierName + ', ìš´ì†¡ì¥ë²ˆí˜¸: ' + number;
            } else {
                // ì°¾ì§€ ëª»í•˜ë©´ raw ê°’ ê·¸ëŒ€ë¡œ í‘œì‹œ
                trackingSpan.textContent = rawTracking;
            }
        }
    }

    // ëª¨ë‹¬ ì—´ê¸°
    function registerTracking() {
        // ì›ë³¸ tracking ê°’(data-raw-tracking)ìœ¼ë¡œ ëª¨ë‹¬ í•„ë“œ ë¯¸ë¦¬ ì±„ìš°ê¸°
        const trackingSpan = document.getElementById('trackingNo');
        const rawTracking = trackingSpan.getAttribute('data-raw-tracking');
        if(rawTracking && rawTracking.includes('/')){
            const parts = rawTracking.split('/');
            const code = parts[0];
            const number = parts[1];
            // íƒë°° ì½”ë“œê°€ êµ­ë‚´ ëª©ë¡ì— ìˆìœ¼ë©´ êµ­ë‚´ë¡œ, ì•„ë‹ˆë©´ êµ­ì œë¡œ ì„¤ì •
            let isDomestic = domesticCouriers.some(courier => courier.code === code);
            if(isDomestic){
                setCourierFilter('domestic');
            } else {
                setCourierFilter('international');
            }
            // drop-downì—ì„œ í•´ë‹¹ ì½”ë“œ ì„ íƒ ë° ì…ë ¥ì°½ì— ìš´ì†¡ì¥ë²ˆí˜¸ ì±„ìš°ê¸°
            document.getElementById('courierSelect').value = code;
            document.getElementById('trackingInput').value = number;
        } else {
            setCourierFilter('domestic');
            document.getElementById('trackingInput').value = '';
        }
        const trackingModal = new bootstrap.Modal(document.getElementById('trackingModal'));
        trackingModal.show();
    }

    // íƒë°° ìœ í˜•ì— ë”°ë¼ <select> ì˜µì…˜ ì±„ìš°ëŠ” í•¨ìˆ˜
    function setCourierFilter(filter) {
        let couriers = [];
        if (filter === 'domestic') {
            couriers = domesticCouriers;
        } else {
            couriers = internationalCouriers;
        }
        const courierSelect = document.getElementById('courierSelect');
        courierSelect.innerHTML = '';  // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”
        couriers.forEach((courier) => {
            const option = document.createElement('option');
            option.value = courier.code;
            option.text = courier.name;
            courierSelect.appendChild(option);
        });
    }

    // í•„í„° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
    document.getElementById('domesticBtn').addEventListener('click', function(){
        setCourierFilter('domestic');
    });
    document.getElementById('internationalBtn').addEventListener('click', function(){
        setCourierFilter('international');
    });

    // ëª¨ë‹¬ ë‚´ 'ë“±ë¡í•˜ê¸°' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸: ì„ íƒí•œ íƒë°°ì‚¬ ì½”ë“œì™€ ìš´ì†¡ì¥ ë²ˆí˜¸ ê²°í•© í›„ ì €ì¥
    document.getElementById('saveTrackingBtn').addEventListener('click', function(){
        const orderId = /*[[${soldDetail.orderId}]]*/ 0;
        const trackingNumber = document.getElementById('trackingInput').value.trim();
        if(trackingNumber === ''){
            alert("ìš´ì†¡ì¥ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }
        const courierSelect = document.getElementById('courierSelect');
        const courierCode = courierSelect.value;
        const combinedTracking = courierCode + '/' + trackingNumber;
        fetch('/history/sold/update-tracking?orderId=' + orderId + '&newTracking=' + encodeURIComponent(combinedTracking), {
            method: 'POST'
        })
            .then(response => response.json())
            .then(data => {
                if(data.updated){
                    // data-raw-tracking ì†ì„± ì—…ë°ì´íŠ¸
                    const trackingSpan = document.getElementById("trackingNo");
                    trackingSpan.setAttribute('data-raw-tracking', combinedTracking);
                    // í‘œì‹œ í…ìŠ¤íŠ¸ë„ ê°±ì‹  (ìœ„ì˜ DOMContentLoaded ì²˜ë¦¬ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ ì ìš©)
                    let courierName = '';
                    domesticCouriers.some(function(courier) {
                        if(courier.code === courierCode){
                            courierName = courier.name;
                            return true;
                        }
                        return false;
                    });
                    if(!courierName) {
                        internationalCouriers.some(function(courier) {
                            if(courier.code === courierCode){
                                courierName = courier.name;
                                return true;
                            }
                            return false;
                        });
                    }
                    if(courierName) {
                        trackingSpan.textContent = 'íƒë°°ì‚¬: ' + courierName + ', ìš´ì†¡ì¥ë²ˆí˜¸: ' + trackingNumber;
                    }
                    document.querySelector('button[onclick="registerTracking()"]').textContent = "ìš´ì†¡ì¥ ìˆ˜ì •";
                    alert("ìš´ì†¡ì¥ ë²ˆí˜¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    // ëª¨ë‹¬ ë‹«ê¸°
                    const modalEl = document.getElementById('trackingModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                } else {
                    alert("ìš´ì†¡ì¥ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    });

    <!-- ë“±ë¡ëœ ìš´ì†¡ì¥ ë²ˆí˜¸ í‘œì‹œ í˜•ì‹ì„ ë³€ê²½í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
    document.addEventListener('DOMContentLoaded', function() {
        const trackingSpan = document.getElementById('trackingNo');
        const rawTracking = trackingSpan.getAttribute('data-raw-tracking');
        if(rawTracking && rawTracking.includes('/')) {
            const parts = rawTracking.split('/');
            const code = parts[0];
            const number = parts[1];
            let courierName = '';
            domesticCouriers.some(function(courier) {
                if(courier.code === code){
                    courierName = courier.name;
                    return true;
                }
                return false;
            });
            if(!courierName) {
                internationalCouriers.some(function(courier) {
                    if(courier.code === code){
                        courierName = courier.name;
                        return true;
                    }
                    return false;
                });
            }
            if(courierName) {
                trackingSpan.textContent = 'íƒë°°ì‚¬: ' + courierName + ', ìš´ì†¡ì¥ë²ˆí˜¸: ' + number;
            }
        }
    });



</script>

</body>
</html>
