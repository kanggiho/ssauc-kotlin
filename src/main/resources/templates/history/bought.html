<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout.html">
<head>
  <meta charset="UTF-8">
  <title>êµ¬ë§¤ ë‚´ì—­ ìƒì„¸</title>
  <!-- í•„ìš”í•œ CSS, JS, CDN ë“± -->
  <link rel="stylesheet" href="/css/mypage.css">
  <script src="/js/smartApiCodes.js"></script>
  <style>
    /* ìºëŸ¬ì…€ ì „ì²´ ì˜ì—­ ë° ê° ìŠ¬ë¼ì´ë“œì˜ ê³ ì • ë†’ì´ ì„¤ì • */
    .carousel-inner,
    .carousel-item {
      height: 300px;
      width: 300px;
      position: relative;
      margin: 0 auto;
    }
    /* ìºëŸ¬ì…€ ìŠ¬ë¼ì´ë“œ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    .carousel-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .carousel-control-prev-icon,
    .carousel-control-next-icon {
      width: 1.5rem;
      height: 1.5rem;
    }

    .carousel-control-prev,
    .carousel-control-next {
      width: 30px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 2;
      position: absolute;
    }

    .carousel-control-prev {
      left: 0;
    }

    .carousel-control-next {
      right: 0;
    }

    .card-body {
      padding-bottom: 0 !important;
    }

    .tracking {
      margin-bottom: 16px;
    }
    .tracking-area {
      margin-top: -24px;  /* ìœ„ë¡œ ì¡°ê¸ˆ ë‹¹ê¸°ê¸° */
    }
    /* ìŠ¤ë§ˆíŠ¸íƒë°° ë°°ì†¡ ì¡°íšŒ ë²„íŠ¼ */
    .smartapi-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      background-color: #17a2b8; /* íŒŒë€ìƒ‰ ê³„ì—´ì˜ ì •ë³´ìƒ‰ìƒ */
      color: white;
      font-size: 14px;
      cursor: pointer;
    }
    /* ê±°ë˜ ì™„ë£Œ ë²„íŠ¼ */
    .complete-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      background-color: #28a745;
      color: white;
      font-size: 14px;
      cursor: pointer;
      margin-right: 16px;
    }
    .complete-btn.completed {
      background-color: #ccc;
      color: #666;
      cursor: pointer;
      border: 1px solid #aaa;
    }
  </style>
</head>
<body>
<div class="container2" layout:fragment="content">
    <!-- ì™¼ìª½ Sidebar (mypage ê·¸ëŒ€ë¡œ) -->
    <div class="sidebar" th:replace="~{mypage/mypage :: sidebar}"></div>
    <!-- ì˜¤ë¥¸ìª½ ë©”ì¸ ì»¨í…ì¸  -->
    <div class="main2">
      <h2 class="mb-4">êµ¬ë§¤ ìƒì„¸ ë‚´ì—­</h2>

      <!-- Section 1 -->
      <div class="card mb-4">
        <div class="card-header fw-bold">êµ¬ë§¤ ìƒí’ˆ ì •ë³´</div>
        <div class="card-body">
          <div class="row align-items-center">
            <!-- ì™¼ìª½: ìƒí’ˆ ì •ë³´ -->
            <div class="col-md-7">
              <p>
                <strong>ìƒí’ˆ ì´ë¦„:</strong>
                <span class="productBid"
                      th:text="${boughtDetail.productName}"
                      th:onclick="|location.href='/bid/bid?productId=' + ${boughtDetail.productId}|">
                </span>
              </p>
              <p><strong>ê²½ë§¤ ì‹œì‘ê°€:</strong> <span th:text="${boughtDetail.startPrice}">10000</span></p>
              <p><strong>ë“±ë¡ ì‹œê°„:</strong> <span
                      th:text="${#temporals.format(boughtDetail.createdAt, 'yyyy-MM-dd HH:mm:ss')}">2025-02-05 14:30:00</span>
              </p>
              <p><strong>ê±°ë˜ ë°©ì‹:</strong> <span
                      th:text="${boughtDetail.dealType == 0 ? 'ğŸ§‘ğŸ» ì§ê±°ë˜' : (boughtDetail.dealType == 1 ? 'ğŸšš íƒë°°ê±°ë˜' : 'ğŸ§‘ğŸ»ğŸšš ì§ê±°ë˜, íƒë°°ê±°ë˜')}">ê±°ë˜ ë°©ì‹</span>
              </p>
              <hr/>
              <p>
                <strong>íŒë§¤ì:</strong>
                <span class="productBid"
                      th:text="${boughtDetail.sellerName}"
                      th:attr="data-sellername=${boughtDetail.sellerName}"
                      onclick="handleSellerClick(event)">user</span>
              </p>
              <p><strong>êµ¬ë§¤ê°€:</strong> <span th:text="${boughtDetail.totalPrice}">50,000 ì›</span></p>
              <p><strong>êµ¬ë§¤ ì‹œê°„:</strong> <span
                      th:text="${#temporals.format(boughtDetail.orderDate, 'yyyy-MM-dd HH:mm:ss')}">2025-02-06 16:45:00</span>
              </p>
              <p><strong>ê±°ë˜ ì™„ë£Œ ì‹œê°„:</strong> <span
                      th:text="${#temporals.format(boughtDetail.completedDate, 'yyyy-MM-dd HH:mm:ss')}">2025-02-06 17:00:00</span>
              </p>
            </div>
            <!-- ì˜¤ë¥¸ìª½: ìƒí’ˆ ì´ë¯¸ì§€ Carousel -->
            <div class="col-md-5">
              <div id="carouselSold" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                  <div th:each="image, iterStat : ${carouselImages}"
                       class="carousel-item"
                       th:classappend="${iterStat.index == 0} ? ' active' : ''">
                    <img th:src="@{${image.url}}" class="d-block w-100" th:alt="${image.alt}"/>
                  </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselSold"
                        data-bs-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">ì´ì „</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselSold"
                        data-bs-slide="next">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">ë‹¤ìŒ</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 2 -->
      <div class="card mb-4">
        <div class="card-header fw-bold">ë°°ì†¡ ìš”ì²­ ì •ë³´</div>
        <div class="card-body">
          <p><strong>ìˆ˜ë ¹ì¸ ì´ë¦„:</strong> <span th:text="${boughtDetail.recipientName}">í™ê¸¸ë™</span></p>
          <p><strong>ìˆ˜ë ¹ì¸ ì—°ë½ì²˜:</strong> <span th:text="${boughtDetail.recipientPhone}">010-1234-5678</span></p>
          <p><strong>ìš°í¸ë²ˆí˜¸:</strong> <span th:text="${boughtDetail.postalCode}">12345</span></p>
          <p><strong>ë°°ì†¡ ì£¼ì†Œ:</strong> <span th:text="${boughtDetail.deliveryAddress}">ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123</span>
          </p>
          <!-- ìš´ì†¡ì¥ ë° ë°°ì†¡ ì¡°íšŒ ì˜ì—­ -->
          <div class="tracking mt-3 d-flex align-items-center">
            <span class="tracking-label fw-bold">ìš´ì†¡ì¥ ì •ë³´:</span>
            <button id="trackingBtn" class="btn btn-primary btn-sm ms-2" onclick="loadTracking()">ìš´ì†¡ì¥ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <span id="trackingText" class="ms-2" style="display: none;"></span>
            <button class="smartapi-btn ms-auto" onclick="submitTrackingForm()">ë°°ì†¡ ì¡°íšŒ</button>
            <!-- ìˆ¨ê²¨ì§„ ë°°ì†¡ ì¡°íšŒ Form ì¶”ê°€ (target="_blank"ë¡œ ìƒˆ ì°½ì—ì„œ ê²°ê³¼ ì¶œë ¥) -->
            <form id="smartTrackingForm" action="/history/tracking-proxy" method="post" target="_blank" style="display: none;">
              <div class="form-group">
                <label for="t_code">íƒë°°ì‚¬ ì½”ë“œ</label>
                <input type="text" class="form-control" name="t_code" id="t_code" value="">
              </div>
              <div class="form-group">
                <label for="t_invoice">ìš´ì†¡ì¥ ë²ˆí˜¸</label>
                <input type="text" class="form-control" name="t_invoice" id="t_invoice" value="">
              </div>
              <button type="submit" class="btn btn-default">ì¡°íšŒí•˜ê¸°</button>
            </form>
          </div>
        </div>
      </div>
      <!-- ê±°ë˜ ì™„ë£Œ ì˜ì—­ -->
      <div class="tracking-area d-flex">
        <button id="completeBtn" class="complete-btn ms-auto" onclick="completeTransaction()"
                th:classappend="${boughtDetail.completedDate != null} ? ' completed' : ''">ê±°ë˜ ì™„ë£Œ</button>
      </div>
  </div>
</div>

<script layout:fragment="script" th:inline="javascript">

  let registeredTracking = /*[[${boughtDetail.deliveryStatus}]]*/ "";

  // ìš´ì†¡ì¥ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
  function loadTracking() {
    if (registeredTracking.trim() !== "") {
      document.getElementById("trackingBtn").style.display = "none"; // ë²„íŠ¼ ìˆ¨ê¹€
      const trackingText = document.getElementById("trackingText");
      let raw = registeredTracking.trim();
      if (raw.includes("/")) {
        const parts = raw.split("/");
        const code = parts[0];
        const number = parts[1];
        let courierName = "";
        // êµ­ë‚´ íƒë°°ì‚¬ ëª©ë¡ì—ì„œ ì½”ë“œ ê²€ìƒ‰
        domesticCouriers.some(function(courier) {
          if (courier.code === code) {
            courierName = courier.name;
            return true;
          }
          return false;
        });
        // êµ­ë‚´ ëª©ë¡ì— ì—†ìœ¼ë©´ êµ­ì œ íƒë°°ì‚¬ ëª©ë¡ì—ì„œ ê²€ìƒ‰
        if (!courierName) {
          internationalCouriers.some(function(courier) {
            if (courier.code === code) {
              courierName = courier.name;
              return true;
            }
            return false;
          });
        }
        if (courierName) {
          trackingText.textContent = "íƒë°°ì‚¬: " + courierName + ", ìš´ì†¡ì¥ë²ˆí˜¸: " + number;
        } else {
          // í•´ë‹¹ ì½”ë“œì— ë§¤ì¹­ë˜ëŠ” íƒë°°ì‚¬ë¥¼ ì°¾ì§€ ëª»í•˜ë©´ ì›ë³¸ ê·¸ëŒ€ë¡œ í‘œì‹œ
          trackingText.textContent = raw;
        }
      } else {
        trackingText.textContent = registeredTracking;
      }
      trackingText.style.display = "inline"; // í…ìŠ¤íŠ¸ í‘œì‹œ
    } else {
      alert("ìš´ì†¡ì¥ ì •ë³´ê°€ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
  }

  // ë“±ë¡ëœ ìš´ì†¡ì¥ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìŠ¤ë§ˆíŠ¸íƒë°° API í”„ë¡ì‹œ í˜¸ì¶œ
  function submitTrackingForm() {
    // registeredTracking ë³€ìˆ˜ëŠ” ì„œë²„ì—ì„œ ì „ë‹¬ëœ ë°°ì†¡ì •ë³´
    let tracking = registeredTracking.trim();
    if (tracking === "ë°°ì†¡ì¤€ë¹„") {
      alert("ì•„ì§ ìš´ì†¡ì¥ ì •ë³´ê°€ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }
    if (!tracking.includes("/")) {
      alert("ìš´ì†¡ì¥ ì •ë³´ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }
    // "/" êµ¬ë¶„ìë¡œ ë¶„ë¦¬í•˜ì—¬ íƒë°°ì‚¬ ì½”ë“œì™€ ìš´ì†¡ì¥ë²ˆí˜¸ë¥¼ ì¶”ì¶œ
    const parts = tracking.split("/");
    const t_code = parts[0];
    const t_invoice = parts[1];
    // hidden formì˜ input ê°’ ì±„ìš°ê¸°
    document.getElementById("t_code").value = t_code;
    document.getElementById("t_invoice").value = t_invoice;
    // API KEYëŠ” ë¯¸ë¦¬ ì„¤ì •í•´ ë‘” ê°’ ì‚¬ìš© (ë˜ëŠ” í•„ìš”ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ì„¤ì •)
    // Form ì œì¶œ (ìƒˆ ì°½ì—ì„œ ì—´ë¦¼)
    document.getElementById("smartTrackingForm").submit();
  }

  // ê±°ë˜ ì™„ë£Œ ê¸°ëŠ¥
  function completeTransaction() {
    const completeBtn = document.getElementById("completeBtn");
    if (completeBtn.classList.contains("completed")) {
      alert("ì´ë¯¸ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
      return;
    }

    if (!confirm("ì •ë§ ê±°ë˜ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      return;
    }

    const orderId = /*[[${boughtDetail.orderId}]]*/ 0;

    fetch('/history/bought/complete?orderId=' + orderId, {
      method: 'POST'
    })
            .then(response => response.text())
            .then(data => {
              if(data.trim() === "ì™„ë£Œ") {
                completeBtn.classList.add("completed");
                alert("ê±°ë˜ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
              } else {
                alert("ê±°ë˜ ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            })
            .catch(error => {
              console.error("Error:", error);
              alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
  }

</script>
</body>
</html>
