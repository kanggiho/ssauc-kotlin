<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout.html">
<head>
    <link rel="stylesheet" th:href="@{/css/list.css}">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<div class="container" layout:fragment="content">

    <!-- ìµœê·¼ ë³¸ ìƒí’ˆ ë°•ìŠ¤ -->
    <div class="floating-box" th:if="${#authentication != null && #authentication.name != 'anonymousUser'}">
        <h6>ìµœê·¼ ë³¸ ë¬¼í’ˆ</h6>
        <!-- ìŠ¤í¬ë¡¤ ì˜ì—­ -->
        <div class="recent-items-container">
            <!-- ìµœê·¼ ë³¸ ìƒí’ˆ ëª©ë¡ ë°˜ë³µ -->
            <div th:each="view : ${recentViews}">
                <a th:href="@{/bid/bid(productId=${view.product.productId})}" class="recent-item">
                    <img th:src="${view.product.imageUrl}" alt="ìƒí’ˆ ì´ë¯¸ì§€">
                </a>
            </div>
        </div>
        <!-- TOP ë²„íŠ¼ -->
        <button id="topBtn" class="top-btn hide">TOP</button>
    </div>

    <div class="container mt-4">
        <div class="row">
            <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
            <div class="col-lg-2">
                <div class="sidebar">
                    <h5>í•„í„°</h5>
                    <div class="canBid">
                        <input class="form-check-input" id="filter_available_bid" type="checkbox" onchange="toggleCheckBox()">
                        <span>ê²½ë§¤ ê°€ëŠ¥ë§Œ ë³´ê¸°</span>
                    </div>

                    <h5>ì¹´í…Œê³ ë¦¬</h5>
                    <div class="category-list">
                        <a th:href="@{/list/category(categoryId=1)}">ë””ì§€í„¸ê¸°ê¸°</a>
                        <a th:href="@{/list/category(categoryId=2)}">ê°€êµ¬/ì¸í…Œë¦¬ì–´</a>
                        <a th:href="@{/list/category(categoryId=3)}">ìœ ì•„ë™</a>
                        <a th:href="@{/list/category(categoryId=4)}">ì—¬ì„±ì˜ë¥˜</a>
                        <a th:href="@{/list/category(categoryId=5)}">ì—¬ì„±ì¡í™”</a>
                        <a th:href="@{/list/category(categoryId=6)}">ë‚¨ì„±íŒ¨ì…˜/ì¡í™”</a>
                        <a th:href="@{/list/category(categoryId=7)}">ìƒí™œê°€ì „</a>
                        <a th:href="@{/list/category(categoryId=8)}">ìƒí™œ/ì£¼ë°©</a>
                    </div>

                    <h5 class="mt-4">ê°€ê²©</h5>
                    <div class="price-filter">
                        <button class="price-button" th:data-min-price="0" th:data-max-price="20000" onclick="filterByPrice(this)">~2ë§Œì›</button>
                        <button class="price-button" th:data-min-price="20000" th:data-max-price="30000" onclick="filterByPrice(this)">2ë§Œì› ~ 3ë§Œì›</button>
                        <button class="price-button" th:data-min-price="30000" th:data-max-price="40000" onclick="filterByPrice(this)">3ë§Œì› ~ 4ë§Œì›</button>
                        <button class="price-button" th:data-min-price="40000" th:data-max-price="200000" onclick="filterByPrice(this)">4ë§Œì› ~ 20ë§Œì›</button>
                    </div>

                    <div class="price-input">
                        <input type="text" id="minPrice" placeholder="ìµœì†Œ ê°€ê²© (ì›)">
                        <span>~</span>
                        <input type="text" id="maxPrice" placeholder="ìµœëŒ€ ê°€ê²© (ì›)">
                        <button onclick="filterByInputPrice()">ğŸ”</button>
                    </div>

                </div>
            </div>

            <!-- ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ -->
            <div class="col-lg-10">
                <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-3">
                    <div class="col" th:each="product : ${secondList}">
                        <div class="card product-card">
                            <button class="icon-btn" th:data-product-id="${product.productId}" onclick="toggleHeart(this)">
                                <i th:class="${product.liked} ? 'bi bi-heart-fill' : 'bi bi-heart'"></i>
                            </button>
                            <a th:href="@{/bid/bid(productId=${product.productId})}">
                                <div class="image-container">
                                    <img    class="product-img"
                                            th:inline="text"
                                            th:style="${product.getGap().equals('â³ ì…ì°° ë§ˆê°') or product.getStatus().equals('íŒë§¤ì™„ë£Œ')? 'filter: opacity(0.3) drop-shadow(0 0 0 #000000);' : ''}"
                                            th:src="${product.imageUrl}" alt="ì‹œê³„">
                                    <div class="overlay-text"
                                         th:if="${product.getGap().equals('â³ ì…ì°° ë§ˆê°') or product.getStatus().equals('íŒë§¤ì™„ë£Œ')}">
                                        â³ ì…ì°° ë§ˆê°
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="product-title" th:text="${product.name}"></p>
                                    <p class="product-price" th:text="${product.price}"></p>
                                    <p class="product-info">[[${product.bidCount}]] | [[${product.gap}]]</p>
                                    <p class="product-info">
                                        [[${product.location}]] | â¤ï¸ <span class="like-count" th:text="${product.likeCount}"></span>
                                    </p>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="pagination-container">
                    <div class="pagination">
                        <th:block th:with="isPriceFiltered=${(param.minPrice != null or param.maxPrice != null)}">

                            <!-- ì´ì „ í˜ì´ì§€ ë²„íŠ¼ -->
                            <a th:if="${secondList.hasPrevious()}"
                               th:href="${isPriceFiltered} ?
                   @{/list/price(minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, categoryId=${param.categoryId}, page=${secondList.number - 1})} :
                   @{/list/list(page=${secondList.number - 1})}"
                               class="page-link">&lt;</a>

                            <!-- í˜ì´ì§€ ë²ˆí˜¸ (5ê°œì”© í‘œì‹œ) -->
                            <th:block th:with="start=${(secondList.number / 5) * 5}, end=${T(java.lang.Math).min(start + 4, secondList.totalPages - 1)}">
                                <a th:each="i : ${#numbers.sequence(start, end)}"
                                   th:href="${isPriceFiltered} ?
                       @{/list/price(minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, categoryId=${param.categoryId}, page=${i})} :
                       @{/list/list(page=${i})}"
                                   th:text="${i + 1}"
                                   th:classappend="${i == secondList.number} ? 'active' : ''"
                                   class="page-link"></a>
                            </th:block>

                            <!-- ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ -->
                            <a th:if="${secondList.hasNext()}"
                               th:href="${isPriceFiltered} ?
                   @{/list/price(minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, categoryId=${param.categoryId}, page=${secondList.number + 1})} :
                   @{/list/list(page=${secondList.number + 1})}"
                               class="page-link">&gt;</a>
                        </th:block>
                    </div>
                </div>




            </div>
        </div>
    </div>

    <script th:inline="javascript">
        var isLoggedIn = /*[[${user != null and user.userId != null}]]*/ false;

        function toggleHeart(button) {
            // ë¡œê·¸ì¸ ì—¬ë¶€ ì²´í¬: ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ í›„ ë¦¬í„´
            if (!isLoggedIn || isLoggedIn === "false") {
                // confirm ì°½ì˜ ê¸°ë³¸ ë²„íŠ¼ì€ ë¸Œë¼ìš°ì €ì— ë”°ë¼ "í™•ì¸"/"ì·¨ì†Œ"ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                // "í™•ì¸"ì„ ëˆ„ë¥´ë©´ true, "ì·¨ì†Œ"(í˜¹ì€ ì•„ë‹ˆì˜¤)ë¥¼ ëˆ„ë¥´ë©´ false ë°˜í™˜.
                if (confirm("ë¡œê·¸ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    // ì‚¬ìš©ìê°€ í™•ì¸ì„ ëˆ„ë¥¸ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = '/login';
                }
                return; // ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ì´í›„ ë™ì‘ ì¤‘ë‹¨
            }

            const productId = button.getAttribute("data-product-id"); // ìƒí’ˆ ì•„ì´ë”” ë°›ê¸°
            const icon = button.querySelector("i");
            const card = button.closest(".product-card");
            const likeCountElement = card.querySelector(".like-count");

            // í˜„ì¬ ì¢‹ì•„ìš” ìˆ˜ íŒŒì‹± (ì‰¼í‘œ ì œê±° í›„ ì •ìˆ˜ ë³€í™˜)
            let currentCount = parseInt(likeCountElement.textContent.replace(/,/g, ''), 10) || 0;

            fetch("/api/like", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    productId: productId
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.liked) {
                        icon.classList.remove("bi-heart");
                        icon.classList.add("bi-heart-fill")
                        currentCount++;
                    } else {
                        icon.classList.remove("bi-heart-fill");
                        icon.classList.add("bi-heart");
                        currentCount = Math.max(0, currentCount - 1);
                    }

                    likeCountElement.textContent = currentCount.toLocaleString();
                })
                .catch(error => console.error("Error:", error));
        }

        function filterByPrice(button) {
            const minPrice = button.getAttribute("data-min-price");
            const maxPrice = button.getAttribute("data-max-price");

            // GET ìš”ì²­ì„ ë³´ë‚¼ URL ìƒì„± (í˜ì´ì§€ ë²ˆí˜¸ í¬í•¨)
            const url = `/list/price?minPrice=${minPrice}&maxPrice=${maxPrice}&page=${0}`;

            // í˜ì´ì§€ ì´ë™
            window.location.href = url;
        }

        function filterByInputPrice() {
            const minPrice = document.getElementById("minPrice").value;
            const maxPrice = document.getElementById("maxPrice").value;

            if (!minPrice || !maxPrice) {
                alert("ìµœì†Œ ê°€ê²©ê³¼ ìµœëŒ€ ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (isNaN(minPrice) || isNaN(maxPrice)) {
                alert("ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }

            if (parseInt(minPrice) > parseInt(maxPrice)) {
                alert("ìµœì†Œ ê°€ê²©ì´ ìµœëŒ€ ê°€ê²©ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // GET ìš”ì²­ì„ ë³´ë‚¼ URL ìƒì„± (í˜ì´ì§€ ë²ˆí˜¸ í¬í•¨)
            const url = `/list/price?minPrice=${minPrice}&maxPrice=${maxPrice}&page=${0}`;

            // í˜ì´ì§€ ì´ë™
            window.location.href = url;
        }

        function toggleCheckBox() {
            let checkbox = document.getElementById('filter_available_bid');
            let params = new URLSearchParams(window.location.search);
            let page = params.get("page") || 0;
            if (checkbox.checked) {
                // ì²´í¬í•œ ê²½ìš° availableBid í•„í„° ì ìš© (filter=true)
                window.location.href = `/list/availableBid?filter=true&page=${page}`;
            } else {
                // ì²´í¬ í•´ì œ ì‹œ filter íŒŒë¼ë¯¸í„° ì—†ì´ ê¸°ë³¸ ë¦¬ìŠ¤íŠ¸ë¡œ ì´ë™
                window.location.href = `/list/list?page=${page}`;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ìœ ì§€

        window.onload = function() {
            let params = new URLSearchParams(window.location.search);
            let isFiltered = params.get("filter") === "true";

            document.getElementById('filter_available_bid').checked = isFiltered;
        };

    </script>

</div>

</html>