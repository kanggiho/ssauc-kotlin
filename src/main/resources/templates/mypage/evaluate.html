<!-- evaluate.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout.html">
<head>
    <meta charset="UTF-8">
    <title>ê±°ë˜ ë¦¬ë·° ì‘ì„±</title>
    <link rel="stylesheet" href="/css/evaluate.css">
</head>
<body>

<div class="evaluation-container" layout:fragment="content">
    <!-- ìƒëŒ€ë°© ì´ë¦„ê³¼ ìƒí’ˆëª…ì€ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ëª¨ë¸ë¡œ ì „ë‹¬ -->
    <h2 class="evaluation-title">
        <span class="productBid"
              th:text="${otherUserName}"
              th:attr="data-sellername=${otherUserName}"
              onclick="handleSellerClick(event)"></span>
        <span th:text="'ë‹˜ê³¼ì˜ ê±°ë˜ëŠ” ì–´ë• ë‚˜ìš”?'"></span>
    </h2>
    <p class="product-name">
        ìƒí’ˆëª…:
        <span class="productBid"
              th:data-href="|${evaluationDto.transactionType=='êµ¬ë§¤' ? '/history/bought?id=' : '/history/sold?id='}${evaluationDto.productId}|"
              th:text="${productName}"
              onclick="location.href=this.dataset.href">
        </span>
    </p>
    <!-- íƒ€ì„ë¦¬í”„ í¼ ë°”ì¸ë”©ì„ í™œìš©í•œ í¼ -->
    <form id="evaluationForm" th:object="${evaluationDto}">
        <!-- ì£¼ë¬¸/ìƒí’ˆ ì‹ë³„ìì™€ ê±°ë˜ ìœ í˜•ì€ ìˆ¨ê²¨ì§„ í•„ë“œë¡œ ì „ë‹¬ -->
        <input type="hidden" th:field="*{orderId}"/>
        <input type="hidden" th:field="*{productId}"/>
        <input type="hidden" th:field="*{transactionType}"/>

        <div class="evaluation-content">
            <!-- í‰ê°€ í•­ëª© (ì‹¤ì œ ì…ë ¥ì€ ì•„ë˜ ë¼ë””ì˜¤ ë²„íŠ¼ì„ í†µí•´ ì§„í–‰) -->
            <div class="evaluation-options" th:switch="*{transactionType}">
                <!-- êµ¬ë§¤ì¸ ê²½ìš° -->
                <div th:case="'êµ¬ë§¤'">
                    <h3>ëŒ€í™” ë§¤ë„ˆëŠ” ì–´ë• ë‚˜ìš”?</h3>
                    <div class="option-row">
                        <label class="option-btn negative">
                            <input type="radio" th:field="*{q1}" value="negative" required/> ğŸ˜ ì•„ì‰¬ì›Œìš”
                        </label>
                        <label class="option-btn positive">
                            <input type="radio" th:field="*{q1}" value="positive"/> ğŸ˜Š ì¹œì ˆí–ˆì–´ìš”
                        </label>
                    </div>
                    <h3>ìƒí’ˆ ìƒíƒœëŠ” ì–´ë• ë‚˜ìš”?</h3>
                    <div class="option-row">
                        <label class="option-btn negative">
                            <input type="radio" th:field="*{q2}" value="negative" required/> ğŸ’” ì„¤ëª…ê³¼ ë‹¬ë¼ìš”
                        </label>
                        <label class="option-btn positive">
                            <input type="radio" th:field="*{q2}" value="positive"/> âœ¨ ë§ˆìŒì— ë“¤ì–´ìš”
                        </label>
                    </div>
                    <h3>ê°€ê²©ì€ ì ì ˆí–ˆë‚˜ìš”?</h3>
                    <div class="option-row">
                        <label class="option-btn negative">
                            <input type="radio" th:field="*{q3}" value="negative" required/> ğŸ¤‘ ë¹„ìŒŒì–´ìš”
                        </label>
                        <label class="option-btn positive">
                            <input type="radio" th:field="*{q3}" value="positive"/> ğŸ¤© í•©ë¦¬ì ì´ì—ìš”
                        </label>
                    </div>
                </div>
                <!-- íŒë§¤ì¸ ê²½ìš° -->
                <div th:case="'íŒë§¤'">
                    <h3>ëŒ€í™” ë§¤ë„ˆëŠ” ì–´ë• ë‚˜ìš”?</h3>
                    <div class="option-row">
                        <label class="option-btn negative">
                            <input type="radio" th:field="*{q1}" value="negative" required/> ğŸ˜ ì•„ì‰¬ì›Œìš”
                        </label>
                        <label class="option-btn positive">
                            <input type="radio" th:field="*{q1}" value="positive"/> ğŸ˜Š ì¹œì ˆí–ˆì–´ìš”
                        </label>
                    </div>
                    <h3>ê°€ê²© í˜‘ìƒ ê³¼ì •ì€?</h3>
                    <div class="option-row">
                        <label class="option-btn negative">
                            <input type="radio" th:field="*{q2}" value="negative" required/> ğŸ¥¶ ë¬´ë¦¬í•œ ìš”ì²­
                        </label>
                        <label class="option-btn positive">
                            <input type="radio" th:field="*{q2}" value="positive"/> ğŸ˜ ê¹”ë”í•œ ê±°ë˜
                        </label>
                    </div>
                    <h3>ìƒí’ˆ ìˆ˜ë ¹ í›„ í”¼ë“œë°±ì€?</h3>
                    <div class="option-row">
                        <label class="option-btn negative">
                            <input type="radio" th:field="*{q3}" value="negative" required/> ğŸš« ì—°ë½ ë‘ì ˆ
                        </label>
                        <label class="option-btn positive">
                            <input type="radio" th:field="*{q3}" value="positive"/> ğŸ’¬ ë¹ ë¥¸ í”¼ë“œë°±
                        </label>
                    </div>
                </div>
            </div>

            <!-- ìƒì„¸ í›„ê¸° ì…ë ¥ -->
            <div class="evaluation-text">
                <h3>ìƒì„¸ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.</h3>
                <textarea th:field="*{reviewContent}" class="review-input"
                          placeholder="ê±°ë˜ ì¤‘ ëŠë‚€ ì ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”." maxlength="300"></textarea>
                <div class="char-counter">0/300</div>
            </div>

        </div>
        <!-- ì™„ë£Œ ë²„íŠ¼ -->
        <div class="button-container">
            <button type="button" class="submit-btn">ì™„ë£Œ</button>
        </div>
    </form>
</div>

<!-- ë¦¬ë·° ë°ì´í„° ìˆ˜ì§‘ í›„ fetch APIë¥¼ í†µí•´ JSONìœ¼ë¡œ ì „ì†¡ -->
<script layout:fragment="script">
    document.addEventListener("DOMContentLoaded", () => {

        const reviewInput = document.querySelector("textarea[name='reviewContent']");
        const charCounter = document.querySelector(".char-counter");

        // í…ìŠ¤íŠ¸ ì…ë ¥ì‹œ ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
        reviewInput.addEventListener("input", function(){
            const currentLength = reviewInput.value.length;
            charCounter.textContent = `${currentLength}/300`;
        });

        const submitButton = document.querySelector(".submit-btn");

        if (submitButton) {
            submitButton.addEventListener("click", async (e) => {
                e.preventDefault();

                // í¼ ë°ì´í„° ìˆ˜ì§‘
                const orderId = document.querySelector("input[name='orderId']").value;
                const productId = document.querySelector("input[name='productId']").value;
                const transactionType = document.querySelector("input[name='transactionType']").value;

                const q1Elem = document.querySelector("input[name='q1']:checked");
                const q2Elem = document.querySelector("input[name='q2']:checked");
                const q3Elem = document.querySelector("input[name='q3']:checked");

                if (!q1Elem || !q2Elem || !q3Elem) {
                    alert("ëª¨ë“  í‰ê°€ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                const q1 = q1Elem.value;
                const q2 = q2Elem.value;
                const q3 = q3Elem.value;
                const reviewContent = document.querySelector("textarea[name='reviewContent']").value;

                if (reviewContent.trim().length < 10) {
                    alert("ìƒì„¸ í›„ê¸°ëŠ” ìµœì†Œ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                // baseScore ê³„ì‚°: ê¸°ë³¸ +1ì ì— ê° í•­ëª©ì— ëŒ€í•´
                // positive: +0.5, negative: -0.5ë¡œ ê°€ì •
                const scoreValue = (q1 === "positive" ? 0.5 : -0.5)
                    + (q2 === "positive" ? 0.5 : -0.5)
                    + (q3 === "positive" ? 0.5 : -0.5);
                const baseScore = 1 + scoreValue;

                // í‰ê°€ ë°ì´í„°ë¥¼ ê°ì²´ë¡œ êµ¬ì„±
                const evaluationData = {
                    orderId: parseInt(orderId),
                    productId: parseInt(productId),
                    transactionType: transactionType,
                    q1: q1,
                    q2: q2,
                    q3: q3,
                    reviewContent: reviewContent,
                    baseScore: baseScore
                };

                try {
                    const response = await fetch('/mypage/evaluate/submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(evaluationData)
                    });
                    if (response.ok) {
                        alert("ë¦¬ë·°ë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.");
                        window.location.href = "/mypage/evaluation?filter=written";
                    } else {
                        alert("ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                } catch (error) {
                    console.error("Error during evaluation submission:", error);
                    alert("ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        } else {
            console.error("ì™„ë£Œ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    });
</script>

</body>
</html>
