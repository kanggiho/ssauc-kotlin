<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout.html">
<head>
    <!-- í•„ìš”í•œ css,js,cdn ë“±ë“± ì¶”ê°€í•˜ê¸° -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <style>
        /* íšŒìƒ‰ ë°°ê²½ ìŠ¤íƒ€ì¼ */
        .disabled-input {
            background-color: #e9ecef !important;
        }
    </style>


</head>

<div class="container" layout:fragment="content">

    <!-- container ì‹œì‘ -->
    <div class="container py-5">

        <!-- ë°°ì†¡ì£¼ì†Œ íŒŒí‹°ì…˜ -->
        <div class="row mb-4">
            <div class="col-12">
                <h3 style="margin-left: 10px">ğŸ“œ ì£¼ë¬¸ì„œ</h3>
                <br>

                <div class="card shadow-sm">
                    <div class="card-header fw-bold">ì§ê±°ë˜ ë° ë°°ì†¡ ì¥ì†Œ</div>
                    <div class="card-body">

                        <form id="addressForm">
                            <!-- ìš°í¸ë²ˆí˜¸ ë° ì°¾ê¸° ë²„íŠ¼ -->
                            <div class="mb-3">
                                <label for="zipcode" class="form-label">ìš°í¸ë²ˆí˜¸</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="zipcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
                                    <button type="button" class="btn btn-outline-secondary" id="addAdressBtn">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°
                                    </button>
                                </div>
                            </div>
                            <!-- ê¸°ë³¸ ì£¼ì†Œ -->
                            <div class="mb-3">
                                <label for="address" class="form-label">ì£¼ì†Œ</label>
                                <input type="text" class="form-control" id="address" placeholder="ì£¼ì†Œ" readonly>
                            </div>
                            <!-- ìƒì„¸ ì£¼ì†Œ -->
                            <div class="mb-3">
                                <label for="addressDetail" class="form-label">ìƒì„¸ ì£¼ì†Œ</label>
                                <input type="text" class="form-control" id="addressDetail" placeholder="ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="saveAddressBtn">ì£¼ì†Œ ì €ì¥</button>
                        </form>

                    </div>
                </div>
            </div>
        </div>

        <!-- ì£¼ë¬¸ìƒí’ˆ íŒŒí‹°ì…˜ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header fw-bold">ì£¼ë¬¸ìƒí’ˆ</div>
                    <div class="card-body">
                        <!-- ì˜ˆì‹œ ìƒí’ˆ ì •ë³´ -->
                        <div class="d-flex align-items-center mb-4"
                             style="border: 1px solid #eee; border-radius: 0.5rem; padding: 1rem;">
                            <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
                            <img
                                    th:src="${product.getImageUrl()}"
                                    alt="ìƒí’ˆ ì´ë¯¸ì§€"
                                    class="img-fluid rounded me-3"
                                    style="width: 80px; height: 80px; object-fit: cover;"
                            >
                            <!-- ìƒí’ˆ ìƒì„¸ -->
                            <div>
                                <h6 class="fw-bold mb-1" th:text="${product.getName()}">ìƒí’ˆëª…</h6>
                                <p class="mb-1 text-muted">ì˜µì…˜ / ìˆ˜ëŸ‰ 1ê°œ</p>
                                <p class="fw-bold mb-0"><span
                                        th:text="${T(java.lang.String).format('%,d P', product.getPrice())}"></span></p>
                            </div>
                        </div>

                        <h6 class="fw-bold">ê±°ë˜ ë°©ì‹</h6>

                        <!-- ë°°ì†¡ ë°©ë²• ì„ íƒ (ë¼ë””ì˜¤ ë²„íŠ¼) -->
                        <div class="mb-3">
                            <div class="form-check form-check-inline"
                                 th:if="${product.dealType == 1 or product.dealType == 2}">
                                <input
                                        class="form-check-input"
                                        type="radio"
                                        name="deliveryOption"
                                        id="deliveryOption1"
                                        value="íƒë°°"
                                        checked>
                                <label class="form-check-label" for="deliveryOption1">íƒë°°</label>
                            </div>

                            <div class="form-check form-check-inline"
                                 th:if="${product.dealType == 0 or product.dealType == 2}">
                                <input
                                        class="form-check-input"
                                        type="radio"
                                        name="deliveryOption"
                                        id="deliveryOption2"
                                        value="ì§ê±°ë˜">
                                <label class="form-check-label" for="deliveryOption2">ì§ê±°ë˜</label>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìµœì¢… ì£¼ë¬¸ì •ë³´ íŒŒí‹°ì…˜ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header fw-bold">ìµœì¢… ì£¼ë¬¸ì •ë³´</div>
                    <div class="card-body">
                        <!-- êµ¬ë§¤ê°€ -->
                        <div class="d-flex justify-content-between mb-2">
                            <span>êµ¬ë§¤ê°€</span>
                            <span th:text="${T(java.lang.String).format('%,d P', price)}"></span>
                        </div>
                        <!-- ìˆ˜ìˆ˜ë£Œ -->
                        <div class="d-flex justify-content-between mb-2">
                            <span>ìˆ˜ìˆ˜ë£Œ</span>
                            <span th:text="${T(java.lang.String).format('%,d P', fee)}"></span>
                        </div>

                        <!-- ì´ ê²°ì œê¸ˆì•¡ -->
                        <div class="border-top pt-3 mt-3 d-flex justify-content-between fw-bold">
                            <span>ì´ ê²°ì œê¸ˆì•¡</span>
                            <span th:text="${T(java.lang.String).format('%,d P', total)}"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê²°ì œí•˜ê¸° ë²„íŠ¼ -->
        <div class="row">
            <div class="col-12 text-end">
                <button type="button" class="btn btn-primary btn-lg">ê²°ì œí•˜ê¸°</button>
            </div>
        </div>

    </div>


    <!-- ê²°ì œ í™•ì¸ Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">ê²°ì œ í™•ì¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>í˜„ì¬ ë³´ìœ  ìºì‹œ: <strong id="userCash">0 P</strong></p>
                    <p>ì´ ê²°ì œ ê¸ˆì•¡: <strong id="totalPayment">0 P</strong></p>
                    <p class="text-danger" id="paymentWarning" style="display: none;">âš ï¸ ë³´ìœ  ìºì‹œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" id="confirmPaymentBtn" disabled>ê²°ì œí•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>


    <!-- container ë -->

    <script>

        let addressSaved = false;

        addAdress()
        saveAdress()
        pay()


        // ìƒˆ ì£¼ì†Œ ì¶”ê°€ ê¸°ëŠ¥ êµ¬í˜„
        function addAdress() {

            document.addEventListener("DOMContentLoaded", function () {
                document.getElementById("addAdressBtn").addEventListener("click", function () {

                    new daum.Postcode({
                        oncomplete: function (data) {
                            // íŒì—…ì—ì„œ ê²€ìƒ‰ê²°ê³¼ í•­ëª©ì„ í´ë¦­í–ˆì„ë•Œ ì‹¤í–‰í•  ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ë¶€ë¶„.

                            // ê° ì£¼ì†Œì˜ ë…¸ì¶œ ê·œì¹™ì— ë”°ë¼ ì£¼ì†Œë¥¼ ì¡°í•©í•œë‹¤.
                            // ë‚´ë ¤ì˜¤ëŠ” ë³€ìˆ˜ê°€ ê°’ì´ ì—†ëŠ” ê²½ìš°ì—” ê³µë°±('')ê°’ì„ ê°€ì§€ë¯€ë¡œ, ì´ë¥¼ ì°¸ê³ í•˜ì—¬ ë¶„ê¸° í•œë‹¤.
                            var addr = ''; // ì£¼ì†Œ ë³€ìˆ˜
                            var extraAddr = ''; // ì°¸ê³ í•­ëª© ë³€ìˆ˜

                            //ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œ íƒ€ì…ì— ë”°ë¼ í•´ë‹¹ ì£¼ì†Œ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.
                            if (data.userSelectedType === 'R') { // ì‚¬ìš©ìê°€ ë„ë¡œëª… ì£¼ì†Œë¥¼ ì„ íƒí–ˆì„ ê²½ìš°
                                addr = data.roadAddress;
                            } else { // ì‚¬ìš©ìê°€ ì§€ë²ˆ ì£¼ì†Œë¥¼ ì„ íƒí–ˆì„ ê²½ìš°(J)
                                addr = data.jibunAddress;
                            }

                            // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œê°€ ë„ë¡œëª… íƒ€ì…ì¼ë•Œ ì°¸ê³ í•­ëª©ì„ ì¡°í•©í•œë‹¤.
                            if (data.userSelectedType === 'R') {
                                // ë²•ì •ë™ëª…ì´ ìˆì„ ê²½ìš° ì¶”ê°€í•œë‹¤. (ë²•ì •ë¦¬ëŠ” ì œì™¸)
                                // ë²•ì •ë™ì˜ ê²½ìš° ë§ˆì§€ë§‰ ë¬¸ìê°€ "ë™/ë¡œ/ê°€"ë¡œ ëë‚œë‹¤.
                                if (data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) {
                                    extraAddr += data.bname;
                                }
                                // ê±´ë¬¼ëª…ì´ ìˆê³ , ê³µë™ì£¼íƒì¼ ê²½ìš° ì¶”ê°€í•œë‹¤.
                                if (data.buildingName !== '' && data.apartment === 'Y') {
                                    extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                                }
                                // í‘œì‹œí•  ì°¸ê³ í•­ëª©ì´ ìˆì„ ê²½ìš°, ê´„í˜¸ê¹Œì§€ ì¶”ê°€í•œ ìµœì¢… ë¬¸ìì—´ì„ ë§Œë“ ë‹¤.
                                if (extraAddr !== '') {
                                    extraAddr = ' (' + extraAddr + ')';
                                }
                                // ì¡°í•©ëœ ì°¸ê³ í•­ëª©ì„ í•´ë‹¹ í•„ë“œì— ë„£ëŠ”ë‹¤.
                                // document.getElementById("sample6_extraAddress").value = extraAddr;

                            } else {
                                // document.getElementById("sample6_extraAddress").value = '';
                            }

                            // ìš°í¸ë²ˆí˜¸ì™€ ì£¼ì†Œ ì •ë³´ë¥¼ í•´ë‹¹ í•„ë“œì— ë„£ëŠ”ë‹¤.
                            document.getElementById("zipcode").value = data.zonecode;
                            document.getElementById("address").value = addr;
                            // ì»¤ì„œë¥¼ ìƒì„¸ì£¼ì†Œ í•„ë“œë¡œ ì´ë™í•œë‹¤.
                            document.getElementById("addressDetail").focus();
                        }
                    }).open();


                });
            });
        }

        function saveAdress() {
            document.addEventListener("DOMContentLoaded", function () {
                // ì£¼ì†Œ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬
                document.getElementById("addressForm").addEventListener("submit", function (e) {
                    e.preventDefault(); // í¼ ê¸°ë³¸ ì œì¶œ ë°©ì§€

                    // ì…ë ¥ í•„ë“œë“¤ ì„ íƒ
                    var zipcodeInput = document.getElementById("zipcode");
                    var addressInput = document.getElementById("address");
                    var addressDetailInput = document.getElementById("addressDetail");
                    var saveBtn = document.getElementById("saveAddressBtn");

                    // ì˜ˆì™¸ ì²˜ë¦¬: ëª¨ë“  í•„ë“œê°€ ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    if (zipcodeInput.value.trim() === "" ||
                        addressInput.value.trim() === "" ||
                        addressDetailInput.value.trim() === "") {
                        alert("ìš°í¸ë²ˆí˜¸, ì£¼ì†Œ, ìƒì„¸ì£¼ì†Œ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return; // ì¡°ê±´ì´ ë§ì§€ ì•Šìœ¼ë©´ ì €ì¥ ì§„í–‰í•˜ì§€ ì•ŠìŒ
                    }

                    // í•„ë“œë“¤ì„ ë¹„í™œì„±í™”(disabled) ë° ìŠ¤íƒ€ì¼ ì ìš©
                    zipcodeInput.setAttribute("disabled", "true");
                    addressInput.setAttribute("disabled", "true");
                    addressDetailInput.setAttribute("disabled", "true");

                    zipcodeInput.classList.add("disabled-input");
                    addressInput.classList.add("disabled-input");
                    addressDetailInput.classList.add("disabled-input");

                    // ì €ì¥ ë²„íŠ¼ë„ ë¹„í™œì„±í™”í•˜ê³  ìŠ¤íƒ€ì¼ ë³€ê²½ (Bootstrap í´ë˜ìŠ¤ ë³€ê²½)
                    saveBtn.classList.remove("btn-primary");
                    saveBtn.classList.add("btn-secondary");
                    saveBtn.setAttribute("disabled", "true");

                    // ë§Œì•½ ì„œë²„ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•´ì•¼ í•œë‹¤ë©´ AJAX í˜¸ì¶œ ë“±ì„ ì§„í–‰
                    // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ UI ë³€ê²½ë§Œ ì²˜ë¦¬í•¨
                    addressSaved = true;
                    alert("ì£¼ì†Œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            });
        }


        function pay() {
            document.addEventListener("DOMContentLoaded", function () {
                const paymentButton = document.querySelector(".btn-primary.btn-lg"); // ê²°ì œí•˜ê¸° ë²„íŠ¼
                const confirmPaymentButton = document.getElementById("confirmPaymentBtn"); // ê²°ì œ í™•ì¸ ë²„íŠ¼
                const userCashDisplay = document.getElementById("userCash"); // ë³´ìœ  ìºì‹œ í‘œì‹œ
                const totalPaymentDisplay = document.getElementById("totalPayment"); // ì´ ê²°ì œ ê¸ˆì•¡ í‘œì‹œ
                const paymentWarning = document.getElementById("paymentWarning"); // ê²½ê³  ë©”ì‹œì§€

                let userCash = parseInt("[[${userCash}]]"); // ì„œë²„ì—ì„œ ë°›ì•„ì˜¬ ì‚¬ìš©ì ë³´ìœ  ìºì‹œ (ì„ì‹œ ê°’)
                //let totalPayment = parseInt(document.querySelector("[th\\:text='${total}']").innerText.replace(/,/g, '')); // ì´ ê²°ì œ ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸°
                let totalPayment = parseInt("[[${total}]]");

                // ê²°ì œí•˜ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ë„ìš°ê¸°
                paymentButton.addEventListener("click", function () {

                    if (!addressSaved) {
                        alert("ë¨¼ì € ì£¼ì†Œë¥¼ ì €ì¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }

                    // í˜„ì¬ ë³´ìœ  ìºì‹œ ë° ê²°ì œ ê¸ˆì•¡ í‘œì‹œ
                    userCashDisplay.innerText = userCash.toLocaleString() + " P";
                    totalPaymentDisplay.innerText = totalPayment.toLocaleString() + " P";

                    // ë³´ìœ  ìºì‹œ ë¶€ì¡± ì‹œ ê²½ê³  ë©”ì‹œì§€ ì¶œë ¥ & ê²°ì œ ë²„íŠ¼ ë¹„í™œì„±í™”
                    if (userCash < totalPayment) {
                        paymentWarning.style.display = "block";
                        confirmPaymentButton.disabled = true;
                    } else {
                        paymentWarning.style.display = "none";
                        confirmPaymentButton.disabled = false;
                    }

                    // Bootstrap 5 Modal ë„ìš°ê¸°
                    let paymentModal = new bootstrap.Modal(document.getElementById("paymentModal"));
                    paymentModal.show();
                });

                // ê²°ì œ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬
                confirmPaymentButton.addEventListener("click", function () {
                    if (userCash >= totalPayment) {
                        userCash -= totalPayment; // ìºì‹œ ì°¨ê°
                        alert("ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë‚¨ì€ ìºì‹œ: " + userCash.toLocaleString() + " P");

                        var zipcodeInput = document.getElementById("zipcode");
                        var addressInput = document.getElementById("address");
                        var addressDetailInput = document.getElementById("addressDetail");


                        // nameì´ "deliveryOption"ì¸ ë¼ë””ì˜¤ ë²„íŠ¼ ì¤‘ ì²´í¬ëœ ê°’ì„ ê°€ì ¸ì˜´
                        const selectedOption = document.querySelector("input[name='deliveryOption']:checked").value;
                        console.log("ì„ íƒëœ ì˜µì…˜:", selectedOption);
                        // ì´í›„ ì„ íƒëœ ì˜µì…˜ì— ë”°ë¼ ë‹¤ë¥¸ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

                        // ì „ì†¡í•  ë°ì´í„° ì¤€ë¹„ (ì—¬ê¸°ì„œ orderRequestDto ì†ì„±ëª…ìœ¼ë¡œ ì „ë‹¬)
                        const orderRequestDto = {
                            productId: [[${orderRequestDto.productId}]],
                            sellerId: [[${orderRequestDto.sellerId}]],
                            buyerId: [[${orderRequestDto.buyerId}]],
                            totalPayment: totalPayment,
                            postalCode: zipcodeInput.value,
                            deliveryAddress: addressInput.value + " " + addressDetailInput.value,
                            selectedOption: selectedOption
                        };

                        // ë™ì ìœ¼ë¡œ form ìƒì„±í•˜ì—¬ POST ìš”ì²­ ì „ì†¡
                        var form = document.createElement("form");
                        form.method = "POST";
                        form.action = "/pay/pay";

                        // orderRequestDtoì˜ ê° ë°ì´í„°ë¥¼ hidden inputì— ë‹´ìŒ
                        for (var key in orderRequestDto) {
                            if (orderRequestDto.hasOwnProperty(key)) {
                                var input = document.createElement("input");
                                input.type = "hidden";
                                input.name = key;
                                input.value = orderRequestDto[key];
                                form.appendChild(input);
                            }
                        }

                        document.body.appendChild(form);
                        form.submit(); // í¼ ì œì¶œ â†’ ì„œë²„ì—ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹¤í–‰ (Flash Attribute ì „ë‹¬)


                    } else {
                        alert("ìºì‹œê°€ ë¶€ì¡±í•˜ì—¬ ê²°ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }
                });
            });
        }

    </script>


</div>
</html>