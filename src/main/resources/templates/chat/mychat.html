<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout.html">
<head>
    <!-- í•„ìš”í•œ css,js,cdn ë“±ë“± ì¶”ê°€í•˜ê¸° (layout.htmlì—ì„œ Bootstrap 5ì™€ ê³µí†µ JS ë¡œë“œ ê°€ì •) -->
    <style>
        /* ë©”ì‹œì§€ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .message-row {
            display: flex;
            margin: 4px 0;
        }

        /* ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ (ì˜¤ë¥¸ìª½) */
        .my-message {
            justify-content: flex-end;
        }

        /* ìƒëŒ€ë°© ë©”ì‹œì§€ (ì™¼ìª½) */
        .other-message {
            justify-content: flex-start;
        }

        /* ë§í’ì„  ê³µí†µ ìŠ¤íƒ€ì¼ */
        .chat-bubble {
            position: relative; /* ë‚´ë¶€ íƒ€ì„ìŠ¤íƒ¬í”„ ìœ„ì¹˜ë¥¼ ìœ„í•œ relative */
            display: inline-block;
            max-width: 60%;
            word-wrap: break-word;
            padding: 8px 12px 8px 12px; /* ê¸°ì¡´ë³´ë‹¤ ì•„ë˜ìª½ paddingì„ ëŠ˜ë¦¼ */
            border-radius: 12px;
            border: 1px solid #ccc;
        }

        /* ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ ë§í’ì„  ë°°ê²½ */
        .my-message .chat-bubble {
            background-color: #ffffff;
            color: #000000;
        }

        /* ìƒëŒ€ë°© ë©”ì‹œì§€ ë§í’ì„  ë°°ê²½ */
        .other-message .chat-bubble {
            background-color: #fff8cd;
            color: #000000;
        }

        /* íƒ€ì„ìŠ¤íƒ¬í”„ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .timestamp {
            position: absolute;
            font-size: 0.75rem;
            color: #666;
        }

        /* ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€: íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ë§í’ì„  ì™¼ìª½ í•˜ë‹¨ì— */
        .my-message .timestamp {
            bottom: 5px;
            left: -123px;
        }

        /* ìƒëŒ€ë°© ë©”ì‹œì§€: íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ë§í’ì„  ì˜¤ë¥¸ìª½ í•˜ë‹¨ì— */
        .other-message .timestamp {
            bottom: 5px;
            right: -123px;
        }

        /* ì±„íŒ…ë°© ëª©ë¡ ìŠ¤íƒ€ì¼ */
        .btn-my-product {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .btn-other-product {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        /* ì„ íƒëœ ì±„íŒ…ë°© ê°•ì¡° */
        .selected-room {
            font-weight: bold !important;
            font-size: 1.1rem !important;
        }

        /* ì±„íŒ…ë°© ëª©ë¡ì—ì„œ ì°¨ë‹¨ëœ ë°©ì— ì ìš©í•  ìŠ¤íƒ€ì¼ (ì—°í•œ ë¹¨ê°•) */
        .banned-room {
            background-color: #f8d7da; /* Bootstrapì˜ danger ë°°ê²½ ìƒ‰ìƒ ê³„ì—´ */
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* ìƒí’ˆ ì •ë³´ ì˜ì—­ */
        #productInfoArea {
            background-color: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }

        #productImage {
            border: 2px solid #ddd;
        }


    </style>
</head>

<div class="container" layout:fragment="content">
    <!-- í•„ìš”í•œ íƒœê·¸ ì¶”ê°€í•˜ê¸° -->

    <div class="row mt-4">
        <div class="col-12">
            <h2 class="mb-4">ë‚´ ì±„íŒ… ëª©ë¡</h2>
        </div>
    </div>

    <!--
        ì¢Œìš° 2ê°œ ì¹´ë“œ:
        - ì™¼ìª½ (ì±„íŒ… ëª©ë¡)
        - ì˜¤ë¥¸ìª½ (ì±„íŒ…ë°© ëŒ€í™”)
    -->
    <div class="row">
        <!-- ì±„íŒ…ë°© ëª©ë¡ (ì™¼ìª½) -->
        <div class="col-12 col-md-4 mb-3">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <strong>ì±„íŒ…ë°© ëª©ë¡</strong>
                </div>
                <div class="card-body" id="roomListArea" style="max-height: 500px; overflow-y:auto;">
                    <!-- ì±„íŒ… ëª©ë¡ì´ ë™ì  ìƒì„±ë  ì˜ì—­ -->
                </div>
            </div>
        </div>

        <!-- ì±„íŒ…ë°© ëŒ€í™” (ì˜¤ë¥¸ìª½) -->
        <div class="col-12 col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <strong>ì±„íŒ…ë°©</strong>
                    <span id="selectedRoomInfo" class="ms-2">ì„ íƒëœ ì±„íŒ…ë°© ì—†ìŒ</span>
                </div>

                <!-- ìƒí’ˆ ì •ë³´ í‘œì‹œ ì˜ì—­ ìˆ˜ì • -->
                <div class="card-body border bg-light mb-3 d-flex justify-content-between align-items-center"
                     id="productInfoArea">
                    <div class="d-flex align-items-center">
                        <img id="productImage" src="https://ssg-be-s3-bucket.s3.ap-northeast-2.amazonaws.com/item.png"
                             alt="ìƒí’ˆ ì´ë¯¸ì§€" class="me-3" style="width: 80px; height: 80px; border-radius: 8px;">
                        <div>
                            <p class="fw-bold mb-1" id="productName">ìƒí’ˆëª…</p>
                            <p class="text-muted mb-1" id="productPrice">ì¦‰ì‹œ êµ¬ë§¤ê°€: -</p>
                            <p class="text-muted" id="productStatus">íŒë§¤ ìƒíƒœ: -</p>
                        </div>
                    </div>

                    <!-- ì‹ ê³  ë° ì°¨ë‹¨/í•´ì œ ë²„íŠ¼ ì˜ì—­, ì´ˆê¸°ì—ëŠ” ê¸°ë³¸ ë²„íŠ¼ë§Œ ë³´ì—¬ì¤Œ -->
                    <div id="actionButtons">
                        <button class="btn btn-danger btn-sm me-2" onclick="reportUser()">ğŸš¨ ì‹ ê³ </button>
                        <button id="banBtn" class="btn btn-secondary btn-sm" onclick="blockUser()">â›” ì°¨ë‹¨</button>
                    </div>

                </div>


                <div class="card-body" id="chatArea" style="height: 400px; overflow-y: auto;">
                    <!-- ë©”ì‹œì§€ ëª©ë¡ í‘œì‹œ -->
                </div>
                <div class="card-footer">
                    <div class="input-group" style="padding-right: 0px">
                        <input type="text" id="msgInput" class="form-control" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" disabled>
                        <button class="btn btn-primary" onclick="sendMessage()" disabled id="sendBtn">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SockJS & STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        /*************************************************************
         * 1. URL íŒŒë¼ë¯¸í„°ì—ì„œ userId ë° productId ì¶”ì¶œ
         *************************************************************/
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');  // í•„ìˆ˜: chat/mychat?userId=xx
        const productIdFromURL = urlParams.get('productId');  // ì„ íƒ: chat/mychat?userId=xx&productId=yy

        /*************************************************************
         * 2. ì „ì—­ ë³€ìˆ˜
         *************************************************************/
        let stompClient = null;          // STOMP í´ë¼ì´ì–¸íŠ¸
        let currentRoomId = null;        // í˜„ì¬ ì„ íƒëœ ì±„íŒ…ë°© ID
        let currentSubscription = null;  // í˜„ì¬ êµ¬ë… ê°ì²´ (ë°© ì „í™˜ ì‹œ unsubscribeìš©)
        let chatRoomList = [];           // ì‚¬ìš©ì ì±„íŒ…ë°© ëª©ë¡ (RESTë¡œ ë°›ì•„ì˜¬ ì˜ˆì •)

        /*************************************************************
         * 3. í˜ì´ì§€ ì´ˆê¸°í™”
         *************************************************************/
        document.addEventListener("DOMContentLoaded", async function () {
            if (!userId) {
                alert("userIdê°€ ì—†ìŠµë‹ˆë‹¤. ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
                return;
            }
            await fetchUserChatRooms(userId);   // ìœ ì €ì˜ ê¸°ì¡´ ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            connectStomp();                    // STOMP ì—°ê²°

            // productIdê°€ URLì— í¬í•¨ë˜ì–´ ìˆë‹¤ë©´ ì±„íŒ…ë°© ìƒì„± í›„ ìë™ ì„ íƒ
            if (productIdFromURL) {
                await createOrSelectChatRoom(userId, productIdFromURL);
            }

            const msgInput = document.getElementById('msgInput');
            msgInput.addEventListener("keyup", function (event) {
                // Enter í‚¤ ì½”ë“œê°€ 13ì´ë©´
                if (event.key === "Enter" || event.keyCode === 13) {
                    // Enter í‚¤ ëˆŒë €ì„ ë•Œ ì „ì†¡ ë²„íŠ¼ í´ë¦­
                    event.preventDefault();
                    sendMessage();
                }
            });
        });

        /*************************************************************
         * 4. ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (REST API)
         *************************************************************/
        async function fetchUserChatRooms(userId) {
            try {
                const response = await fetch(`/api/chat/user/${userId}/rooms`);
                if (response.ok) {
                    chatRoomList = await response.json(); // [{chatRoomId, productName, otherUserName, sellerId, productImage, productPrice, productStatus, ...}, ...]
                    renderChatRoomList();
                } else {
                    console.error("ì±„íŒ…ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
                }
            } catch (err) {
                console.error("Error fetching chat rooms:", err);
            }
        }

        /*************************************************************
         * 5. ì±„íŒ…ë°© ìƒì„± í›„ ìë™ ì„ íƒ (REST API í˜¸ì¶œ)
         *************************************************************/
        async function createOrSelectChatRoom(userId, productId) {
            try {
                const response = await fetch(`/api/chat/rooms?productId=${productId}&buyerId=${userId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                if (!response.ok) {
                    console.error("ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨");
                    return;
                }
                const newRoom = await response.json(); // ìƒì„±ëœ ì±„íŒ…ë°© ì •ë³´

                // ì±„íŒ…ë°© ëª©ë¡ ì¬ìš”ì²­
                await fetchUserChatRooms(userId);

                // ìë™ ì„ íƒ: ìƒˆë¡œ ë¶ˆëŸ¬ì˜¨ ëª©ë¡ì—ì„œ ìƒì„±ëœ ë°© ì°¾ê¸°
                const selectedRoom = chatRoomList.find(room => String(room.chatRoomId) === String(newRoom.chatRoomId));
                if (selectedRoom) {
                    selectChatRoom(selectedRoom);
                }
            } catch (error) {
                console.error("Error creating chat room:", error);
            }
        }


        /*************************************************************
         * 6. ì±„íŒ…ë°© ëª©ë¡ì„ ì™¼ìª½ íŒ¨ë„ì— ë Œë”ë§
         *************************************************************/
        function renderChatRoomList() {
            const roomListArea = document.getElementById('roomListArea');
            roomListArea.innerHTML = ''; // ì´ˆê¸°í™”

            if (chatRoomList.length === 0) {
                roomListArea.innerHTML = '<p>ë“±ë¡ëœ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const div = document.createElement('div');
            div.className = 'list-group';

            chatRoomList.forEach(room => {
                const btn = document.createElement('button');
                btn.className = 'list-group-item list-group-item-action';
                btn.innerText = `${room.otherUserName} (ìƒí’ˆ: ${room.productName})`;

                // ìƒ‰ìƒ ê²°ì • (ë‚´ ë¬¼ê±´: sellerId === userId â†’ ì—°ì´ˆë¡ìƒ‰, íƒ€ì¸ ë¬¼ê±´: ì—°íŒŒë‘ìƒ‰)
                if (String(room.sellerId) === String(userId)) {
                    btn.classList.add('btn-my-product');
                } else {
                    btn.classList.add('btn-other-product');
                }

                // ë§Œì•½ ì°¨ë‹¨ëœ ìƒíƒœë¼ë©´ banned-room í´ë˜ìŠ¤ ì¶”ê°€ (ì—°í•œ ë¹¨ê°•)
                if (room.banned) {
                    btn.classList.add('banned-room');
                }

                // ì„ íƒëœ ì±„íŒ…ë°© ê°•ì¡° (ê¸€ì”¨ Bold ë° í¬ê¸° ì¦ê°€)
                if (currentRoomId && String(room.chatRoomId) === String(currentRoomId)) {
                    btn.classList.add('selected-room');
                }

                btn.onclick = () => selectChatRoom(room);
                div.appendChild(btn);
            });

            roomListArea.appendChild(div);
        }

        /*************************************************************
         * 7. STOMP ì—°ê²°
         *************************************************************/
        function connectStomp() {
            const socket = new SockJS(window.location.origin + '/ws-stomp');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log("STOMP ì—°ê²° ì„±ê³µ:", frame);
            }, function (error) {
                console.error("STOMP ì—°ê²° ì‹¤íŒ¨:", error);
            });
        }

        /*************************************************************
         * 8. ì±„íŒ…ë°© ì„ íƒ ì‹œ: êµ¬ë…/ì´ì „ ë©”ì‹œì§€ ë¡œë“œ + ìƒí’ˆ ì •ë³´ í‘œì‹œ
         *************************************************************/
        async function selectChatRoom(room) {
            if (!stompClient) {
                alert("STOMPê°€ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            // ê¸°ì¡´ ë°© êµ¬ë… í•´ì œ
            if (currentSubscription) {
                currentSubscription.unsubscribe();
            }

            currentRoomId = room.chatRoomId;
            console.log("selectChatRoom - currentRoomId:", currentRoomId);
            document.getElementById('selectedRoomInfo').innerText = `${room.otherUserName}`;

            // ì±„íŒ… ì…ë ¥ì°½ í™œì„±í™”
            document.getElementById('msgInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;

            // ìƒí’ˆ ì •ë³´ ì˜ì—­ í‘œì‹œ (ìƒí’ˆ ì •ë³´ê°€ ìˆì„ ê²½ìš°)
            displayProductInfo(room);

            // ë§ˆì§€ë§‰ ë³´ë‚¸ ì‚¬ëŒ ì´ˆê¸°í™”
            lastSenderId = null;

            // ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
            await loadOldMessages(room.chatRoomId);

            // STOMP êµ¬ë…
            currentSubscription = stompClient.subscribe(`/sub/chat/room/${room.chatRoomId}`, function (msg) {
                const body = JSON.parse(msg.body);
                addMessage(body.senderId, body.message, body.sentAt);
            });

            renderChatRoomList();
            updateActionButtons(room);
        }

        function updateActionButtons(room) {
            const actionButtonsDiv = document.getElementById('actionButtons');
            actionButtonsDiv.innerHTML = `
        <button class="btn btn-danger btn-sm me-2" onclick="reportUser()">ğŸš¨ ì‹ ê³ </button>
        <button id="banBtn" class="btn btn-secondary btn-sm">
            ${room.banned ? 'ğŸ—ï¸ ì°¨ë‹¨ í•´ì œ' : 'â›” ì°¨ë‹¨'}
        </button>
    `;
            document.getElementById('banBtn').onclick = room.banned ? unbanUser : blockUser;
        }

        /*************************************************************
         * 9. ì±„íŒ…ë°© ì´ì „ ë©”ì‹œì§€ ë¡œë“œ
         *************************************************************/
        async function loadOldMessages(roomId) {
            try {
                const res = await fetch(`/api/chat/rooms/${roomId}/messages`);
                if (res.ok) {
                    const messages = await res.json();
                    const chatArea = document.getElementById('chatArea');
                    chatArea.innerHTML = '';
                    messages.forEach(msg => {
                        addMessage(msg.senderId, msg.message, msg.sentAt);
                    });
                } else {
                    console.error("ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
                }
            } catch (err) {
                console.error("Error loading old messages:", err);
            }
        }

        /*************************************************************
         * 10. ë©”ì‹œì§€ ì „ì†¡
         *************************************************************/
        function sendMessage() {

            // ì°¨ë‹¨ëœ ìƒíƒœë©´ ë©”ì‹œì§€ ì „ì†¡ ê¸ˆì§€
            const selectedRoom = chatRoomList.find(room => String(room.chatRoomId) === String(currentRoomId));
            if (selectedRoom && selectedRoom.banned) {
                alert("ì°¨ë‹¨ ìƒíƒœì´ë¯€ë¡œ ì±„íŒ…ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return;
            }

            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text || !currentRoomId) return;

            const dto = {
                chatRoomId: currentRoomId,
                senderId: userId,
                otherUserId: selectedRoom.otherUserId,
                message: text
            };
            stompClient.send('/pub/chat/message', {}, JSON.stringify(dto));
            input.value = '';
        }

        /*************************************************************
         * 11. ë©”ì‹œì§€ í™”ë©´ì— "ë§í’ì„ " í˜•íƒœë¡œ ì¶”ê°€
         *************************************************************/
        function addMessage(senderId, message, sentAt) {
            const chatArea = document.getElementById('chatArea');

            // (1) ë©”ì‹œì§€ í•œ ì¤„ ê°ì‹¸ëŠ” div
            const wrapper = document.createElement('div');
            wrapper.classList.add('message-row');

            // (2) ë§í’ì„  ì—­í• ì„ í•˜ëŠ” div (ê¸°ì¡´ì—” spanì´ì—ˆìœ¼ë‚˜, ì ˆëŒ€ìœ„ì¹˜ ì‚¬ìš© í¸ì˜ë¥¼ ìœ„í•´ divë„ OK)
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble');
            bubble.textContent = message;  // ë§í’ì„ ì— ë©”ì‹œì§€ ì‚½ì…

            // (3) ì‹œê°„ í‘œì‹œìš© small íƒœê·¸
            const timeElem = document.createElement('small');
            timeElem.classList.add('timestamp');

            if (sentAt) {
                const date = new Date(sentAt);
                const year = date.getFullYear();
                const month = date.getMonth() + 1; // ì›”ì€ 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ 1 ì¶”ê°€
                const day = date.getDate();
                let hours = date.getHours();
                const minutes = date.getMinutes();
                const period = hours < 12 ? "ì˜¤ì „" : "ì˜¤í›„";
                hours = hours % 12 || 12; // 12ì‹œê°„ì œë¡œ ë³€í™˜, 0ì´ë©´ 12ë¡œ
                const formattedMinutes = minutes < 10 ? "0" + minutes : minutes;
                timeElem.textContent = `${year}. ${month}. ${day} ${period} ${hours}:${formattedMinutes}`;
            } else {
                timeElem.textContent = '';
            }

            bubble.appendChild(timeElem);

            // ë³´ë‚¸ ì‚¬ëŒì— ë”°ë¼ ë§í’ì„  ì „ì²´ ì •ë ¬
            if (String(senderId) === String(userId)) {
                wrapper.classList.add('my-message');        // ì˜¤ë¥¸ìª½ ì •ë ¬ìš©
            } else {
                wrapper.classList.add('other-message');     // ì™¼ìª½ ì •ë ¬ìš©
            }

            // ìµœì¢… ì¡°í•©
            wrapper.appendChild(bubble);
            chatArea.appendChild(wrapper);

            // ìë™ ìŠ¤í¬ë¡¤
            chatArea.scrollTop = chatArea.scrollHeight;
        }


        /*************************************************************
         * 12. ìƒí’ˆ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
         *************************************************************/
        function displayProductInfo(room) {
            document.getElementById('productImage').src = room.productImage || 'https://ssg-be-s3-bucket.s3.ap-northeast-2.amazonaws.com/item.png';
            document.getElementById('productName').innerText = room.productName || 'ìƒí’ˆëª… ì—†ìŒ';
            document.getElementById('productPrice').innerText = `ì¦‰ì‹œ êµ¬ë§¤ê°€: ${room.productPrice ? room.productPrice.toLocaleString() + 'P' : '-'}`;
            document.getElementById('productStatus').innerText = `íŒë§¤ ìƒíƒœ: ${room.productStatus || '-'}`;

        }


        /*************************************************************
         * 13. ì‹ ê³  ë²„íŠ¼ í´ë¦­ ì‹œ GET ìš”ì²­ ë¡œì§
         *************************************************************/
        function reportUser() {
            if (!currentRoomId) {
                alert("ì‹ ê³ í•  ì±„íŒ…ë°©ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            const selectedRoom = chatRoomList.find(room => String(room.chatRoomId) === String(currentRoomId));
            if (!selectedRoom) {
                alert("ì‹ ê³ í•  ì±„íŒ…ë°© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const reportedUserId = selectedRoom.otherUserId; // ì‹ ê³  ëŒ€ìƒ ìœ ì € ID

            // GET ìš”ì²­ í›„ í˜ì´ì§€ ì´ë™
            window.location.href = `/chat/report?roomId=${currentRoomId}&reported=${reportedUserId}`;
        }


        /*************************************************************
         * 14. ì°¨ë‹¨ ë²„íŠ¼ í´ë¦­ ì‹œ (ì¼ë‹¨ ì•Œë¦¼ë§Œ í‘œì‹œ)
         *************************************************************/
        function blockUser() {
            if (!currentRoomId) {
                alert("ì°¨ë‹¨í•  ì±„íŒ…ë°©ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            // ì°¨ë‹¨í•  ëŒ€ìƒ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì˜ˆì‹œ: ì±„íŒ…ë°© ì •ë³´ì—ì„œ otherUserId ì‚¬ìš©)
            const selectedRoom = chatRoomList.find(room => String(room.chatRoomId) === String(currentRoomId));
            if (!selectedRoom || !selectedRoom.otherUserId) {
                alert("ì°¨ë‹¨í•  ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // ì°¨ë‹¨ ì—¬ë¶€ í™•ì¸
            if (!confirm("ì •ë§ ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }

            // ì°¨ë‹¨ API í˜¸ì¶œ (ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œë¡œ '/api/chat/ban' ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©)
            axios.post('/api/chat/ban', {
                userId: userId, // ì°¨ë‹¨í•˜ëŠ” ì‚¬ìš©ì (í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì)
                blockedUserId: selectedRoom.otherUserId // ì°¨ë‹¨ ë‹¹í•˜ëŠ” ì‚¬ìš©ì
                // ì¶”ê°€ì ìœ¼ë¡œ blockedAt, status ë“±ì€ ì„œë²„ì—ì„œ ìë™ ì²˜ë¦¬í•˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            })
                .then(response => {
                    alert("ì°¨ë‹¨ ì„±ê³µ!");
                    location.reload();
                })
                .catch(error => {
                    console.error("ì°¨ë‹¨ ìš”ì²­ ì‹¤íŒ¨:", error);
                    if (error.response && error.response.data) {
                        // ì„œë²„ì—ì„œ ë°˜í™˜í•œ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ìˆì„ ê²½ìš°
                        alert(error.response.data);
                    } else {
                        alert("ì°¨ë‹¨ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    }
                });
        }

        /*************************************************************
         * 15. ì°¨ë‹¨í•´ì œ ë²„íŠ¼ í´ë¦­ ì‹œ
         *************************************************************/

        function unbanUser() {
            if (!currentRoomId) {
                alert("ì°¨ë‹¨ í•´ì œí•  ì±„íŒ…ë°©ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            const selectedRoom = chatRoomList.find(room => String(room.chatRoomId) === String(currentRoomId));
            if (!selectedRoom || !selectedRoom.otherUserId) {
                alert("ì°¨ë‹¨ í•´ì œí•  ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            if (!confirm("ì •ë§ ì°¨ë‹¨ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }

            // ì°¨ë‹¨ í•´ì œ API í˜¸ì¶œ (ì˜ˆì‹œ ì—”ë“œí¬ì¸íŠ¸: '/api/chat/unban')
            axios.post('/api/chat/unban', {
                userId: userId,
                blockedUserId: selectedRoom.otherUserId
            })
                .then(response => {
                    alert("ì°¨ë‹¨ í•´ì œ ì„±ê³µ!");
                    location.reload();
                })
                .catch(error => {
                    console.error("ì°¨ë‹¨ í•´ì œ ìš”ì²­ ì‹¤íŒ¨:", error);
                    if (error.response && error.response.data) {
                        alert(error.response.data);
                    } else {
                        alert("ì°¨ë‹¨ í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    }
                });
        }





    </script>

</div>
</html>
