<!--insert.html-->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout.html">
<head>
    <meta charset="UTF-8">
    <title>ìƒí’ˆ ë“±ë¡</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/insert.css">
</head>
<body>

<div class="product-container" layout:fragment="content">
    <!-- ìƒí’ˆ ì •ë³´ ì…ë ¥ ì„¹ì…˜ -->
    <section class="product-info">
        <h2>ìƒí’ˆ ì •ë³´</h2>
        <table class="product-table">
            <tr>
                <td class="label-cell"> ìƒí’ˆ ì œëª©</td>
                <td class="input-cell"><input type="text" placeholder="ìƒí’ˆ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></td>
                <td class="label-cell"> ì¹´í…Œê³ ë¦¬</td>
                <td class="input-cell">
                    <select>
                        <option>ì„ íƒí•˜ì„¸ìš”</option>
                        <option>ë””ì§€í„¸ê¸°ê¸°</option>
                        <option>ê°€êµ¬/ì¸í…Œë¦¬ì–´</option>
                        <option>ìœ ì•„ë™</option>
                        <option>ì—¬ì„±ì˜ë¥˜</option>
                        <option>ì—¬ì„±ì¡í™”</option>
                        <option>ë‚¨ì„±íŒ¨ì…˜/ì¡í™”</option>
                        <option>ìƒí™œê°€ì „</option>
                        <option>ìƒí™œ/ì£¼ë°©</option>
                        <option>ìŠ¤í¬ì¸ /ë ˆì €</option>
                        <option>ì·¨ë¯¸/ê²Œì„/ìŒë°˜</option>
                        <option>ë·°í‹°/ë¯¸ìš©</option>
                        <option>ì‹í’ˆ</option>
                        <option>ê°€ê³µì‹í’ˆ</option>
                        <option>ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ</option>
                        <option>ë°˜ë ¤ë™ë¬¼ìš©í’ˆ</option>
                        <option>í‹°ì¼“/êµí™˜ê¶Œ</option>
                        <option>ë„ì„œ</option>
                        <option>ìœ ì•„ë„ì„œ</option>
                        <option>ê¸°íƒ€ ì¤‘ê³ ë¬¼í’ˆ</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td class="label-cell"> ì´ë¯¸ì§€ ë“±ë¡ <br><small>(ìµœì†Œ 1ì¥ ~ ìµœëŒ€ 5ì¥)</small></td>
                <td class="input-cell" colspan="3">
                    <div class="image-upload">
                        <div class="image-dropzone" id="dropzone">ì—…ë¡œë“œí•œ íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.</div>
                        <input type="file" id="fileInput" multiple style="display: none;">
                        <button class="file-btn" onclick="document.getElementById('fileInput').click();">íŒŒì¼ ì²¨ë¶€</button>
                        <p>ëŒ€í‘œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ë ¤ë©´ í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì„¸ìš”.</p>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label-cell"> ìƒí’ˆ ì„¤ëª…</td>
                <td class="input-cell" colspan="3"><textarea placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea></td>
            </tr>
        </table>
    </section>

    <!-- ê²½ë§¤ ì„¤ì • ì„¹ì…˜ -->
    <section class="auction-settings">
        <h2 class="auction-name">ê²½ë§¤ ì„¤ì •</h2>
        <table class="auction-table">
            <tr>
                <td class="label-cell">ì‹œì‘ê°€</td>
                <td class="input-cell"><input type="number" class="start-price" placeholder="0"> ì›</td>
                <td class="label-cell">ì¦‰ì‹œ êµ¬ë§¤ê°€</td>
                <td class="input-cell"><input type="number" class="instant-price" placeholder="0"> ì›</td>
                <td class="label-cell">ìµœì†Œì…ì°°ë‹¨ìœ„</td>
                <td class="input-cell">
                    <select class="min-increment">
                        <option>ì„ íƒí•˜ì„¸ìš”</option>
                        <option>100ì›</option>
                        <option>500ì›</option>
                        <option>1000ì›</option>
                        <option>5000ì›</option>
                        <option>10000ì›</option>
                        <option>100000ì›</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td class="label-cell"> ê±°ë˜ ìœ í˜•</td>
                <td class="input-cell deal-type">
                    <label class="check-box"><input type="checkbox"> ì§ê±°ë˜</label>
                    <label class="check-box box2"><input type="checkbox"> íƒë°°</label>
                </td>
                <td class="label-cell"> ë§ˆê° ì‹œê°„</td>
                <td class="input-cell" colspan="3">
                    <input type="date" class="auction-date"> ì¼
                    <select class="auction-time">
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                        <option>4</option>
                        <option>5</option>
                        <option>6</option>
                        <option>7</option>
                        <option>8</option>
                        <option>9</option>
                        <option>10</option>
                        <option>11</option>
                        <option>12</option>
                        <option>13</option>
                        <option>14</option>
                        <option>15</option>
                        <option>16</option>
                        <option>17</option>
                        <option>18</option>
                        <option>19</option>
                        <option>20</option>
                        <option>21</option>
                        <option>22</option>
                        <option>23</option>
                        <option>24</option>
                    </select> ì‹œ
                    <select class="auction-time">
                        <option>0</option>
                        <option>10</option>
                        <option>20</option>
                        <option>30</option>
                        <option>40</option>
                        <option>50</option>
                    </select> ë¶„
                </td>
            </tr>
        </table>
    </section>

    <!-- ë²„íŠ¼ ì˜ì—­ -->
    <div class="button-group">
        <button class="cancel">ì·¨ì†Œ</button>
        <button class="submit">ìƒí’ˆ ë“±ë¡</button>
    </div>
</div>

<script layout:fragment="script">
    document.addEventListener("DOMContentLoaded", () => {

        let accumulatedFiles = [];  // ì „ì—­ ë°°ì—´ ì„ ì–¸: ëˆ„ì ëœ íŒŒì¼ë“¤ì„ ì €ì¥
        let representativeIndex = 0;  // ëŒ€í‘œ ì´ë¯¸ì§€ ì¸ë±ìŠ¤ (ê¸°ë³¸ì ìœ¼ë¡œ ì²« ë²ˆì§¸ ì´ë¯¸ì§€)

        const fileInput = document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');

        // íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ë° ëˆ„ì  ì²˜ë¦¬
        fileInput.addEventListener('change', (event) => {
            // ìƒˆë¡œ ì„ íƒí•œ íŒŒì¼ë“¤ì„ ë°°ì—´ë¡œ ë³€í™˜
            const newFiles = Array.from(event.target.files);
            // ì´ íŒŒì¼ ìˆ˜ê°€ 5ì¥ì„ ì´ˆê³¼í•˜ëŠ”ì§€ í™•ì¸
            if (accumulatedFiles.length + newFiles.length > 5) {
                alert("ìµœëŒ€ 5ì¥ì˜ ì´ë¯¸ì§€ë§Œ ì²¨ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                fileInput.value = ""; // fileInput ì´ˆê¸°í™”
                return;
            }
            // ìƒˆë¡œ ì„ íƒí•œ íŒŒì¼ë“¤ì„ í•˜ë‚˜ì”© ê²€ì¦ í›„ ëˆ„ì 
            newFiles.forEach(file => {
                if (!file.type.startsWith('image/')) {
                    alert("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    return;
                }
                if (file.size > 3 * 1024 * 1024) {
                    alert("íŒŒì¼ í¬ê¸°ëŠ” 3MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                accumulatedFiles.push(file);
            });
            fileInput.value = ""; // ì„ íƒ í›„ ì´ˆê¸°í™”í•´ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ í•¨
            updatePreview();
        });

        // ëˆ„ì ëœ ëª¨ë“  íŒŒì¼ë“¤ì„ ì´ìš©í•˜ì—¬ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updatePreview() {
            dropzone.innerHTML = "";
            accumulatedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const container = document.createElement("div");
                    container.classList.add("image-container");

                    const img = document.createElement('img');
                    img.src = e.target.result;

                    if (index === representativeIndex) {  // ëŒ€í‘œ ì´ë¯¸ì§€ ê°•ì¡°
                        img.style.border = "3px solid red";
                        img.style.animation = "border-glow 0.7s infinite alternate";
                    }

                    img.addEventListener("click", () => {
                        representativeIndex = index; // ì„ íƒí•œ ì´ë¯¸ì§€ì˜ ì¸ë±ìŠ¤ë¥¼ ëŒ€í‘œë¡œ ì„¤ì •
                        updatePreview(); // ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
                    });

                    // ğŸŒŸ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                    const deleteBtn = document.createElement("button");
                    deleteBtn.innerText = "X";
                    deleteBtn.classList.add("delete-btn");

                    deleteBtn.addEventListener("click", (e) => {
                        e.stopPropagation(); // ë¶€ëª¨ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
                        accumulatedFiles.splice(index, 1); // ë°°ì—´ì—ì„œ ì‚­ì œ
                        representativeIndex = 0; // ëŒ€í‘œ ì´ë¯¸ì§€ ì´ˆê¸°í™”
                        updatePreview(); // ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
                    });

                    container.appendChild(img);
                    container.appendChild(deleteBtn);
                    dropzone.appendChild(container);
                };
                reader.readAsDataURL(file);
            });
        }

        const submitButton = document.querySelector(".submit");

        if (submitButton) {
            submitButton.addEventListener("click", async (e) => {
                e.preventDefault();

                // ì…ë ¥ê°’ ìˆ˜ì§‘
                const name = document.querySelector('input[placeholder="ìƒí’ˆ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."]').value;
                const categorySelect = document.querySelectorAll('select')[0];  // ì¹´í…Œê³ ë¦¬: ì„ íƒí•œ ì˜µì…˜ì˜ í…ìŠ¤íŠ¸(ì´ë¦„)ë¥¼ ì‚¬ìš©
                const categoryName = categorySelect.value;  // ì˜ˆ: "ë””ì§€í„¸ê¸°ê¸°", "ê°€êµ¬/ì¸í…Œë¦¬ì–´", ë“±
                const description = document.querySelector('textarea').value;
                const startPrice = document.querySelector('.start-price').value;
                const price = document.querySelector('.instant-price').value;
                const dealTypeContainer = document.querySelector('.deal-type');
                const dealCheckboxes = dealTypeContainer.querySelectorAll('input[type="checkbox"]');
                const minIncrementSelect = document.querySelector('.min-increment');
                const minIncrementOption = minIncrementSelect.value;
                // ë§ˆê° ì‹œê°„ ì…ë ¥ê°’ ìˆ˜ì§‘
                const auctionDate = document.querySelector('.auction-date').value;  // YYYY-MM-DD
                const auctionTimeSelects = document.querySelectorAll('.auction-time');
                const auctionHour = auctionTimeSelects[0].value;
                const auctionMinute = auctionTimeSelects[1].value;

                if (accumulatedFiles.length === 0) {
                    alert("ìµœì†Œ 1ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤.");
                    return;
                }
                // íŒŒì¼ ì—…ë¡œë“œ: accumulatedFiles ë°°ì—´ ì‚¬ìš© (ëˆ„ì ëœ íŒŒì¼ë“¤ì„ ì „ì†¡)
                let uploadedImageUrls = "";
                if (accumulatedFiles.length > 0) {
                    let formDataFiles = new FormData();
                    // ëŒ€í‘œ ì´ë¯¸ì§€ë¥¼ ë§¨ ì•ìœ¼ë¡œ ì´ë™
                    let reorderedFiles = [accumulatedFiles[representativeIndex], ...accumulatedFiles.filter((_, i) => i !== representativeIndex)];
                    // accumulatedFilesì˜ íŒŒì¼ë“¤ì„ ëª¨ë‘ FormDataì— ì¶”ê°€
                    reorderedFiles.forEach(file => formDataFiles.append("files", file));
                    try {
                        const uploadResponse = await fetch('/product/uploadMultiple', {
                            method: 'POST',
                            body: formDataFiles
                        });
                        if (!uploadResponse.ok) {
                            alert("ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                            return;
                        }
                        const uploadResult = await uploadResponse.json();
                        uploadedImageUrls = uploadResult.urls; // ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ URL ë¬¸ìì—´
                    } catch (error) {
                        console.error("Error during file upload:", error);
                        alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        return;
                    }
                }


                let dealType = -1;
                if(dealCheckboxes.length === 2) {
                    const isDirect = dealCheckboxes[0].checked;
                    const isDelivery = dealCheckboxes[1].checked;
                    if(isDirect && !isDelivery) {
                        dealType = 0;
                    } else if(!isDirect && isDelivery) {
                        dealType = 1;
                    } else if(isDirect && isDelivery) {
                        dealType = 2;
                    } else {
                        alert("ê±°ë˜ ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                        return;
                    }
                } else {
                    alert("ê±°ë˜ ìœ í˜• ì„ íƒ ì˜¤ë¥˜.");
                    return;
                }


                let minIncrement = 0;
                if(minIncrementOption !== "ì„ íƒí•˜ì„¸ìš”") {
                    minIncrement = parseInt(minIncrementOption.replace('ì›',''));
                } else {
                    alert("ìµœì†Œ ì…ì°° ë‹¨ìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                // âŒ í•„ìˆ˜ ì…ë ¥ê°’ ì²´í¬
                if (!name || categoryName === "ì„ íƒí•˜ì„¸ìš”" || !description || !startPrice || !price || !auctionDate) {
                    alert("ëª¨ë“  í•„ìˆ˜ ì…ë ¥ê°’ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                    return;
                }

                // âŒ ìˆ«ì ê°’ ê²€ì¦
                if (isNaN(startPrice) || isNaN(price) || parseInt(startPrice) < 1000 || parseInt(price) < 1000) {
                    alert("ê²½ë§¤ ì‹œì‘ê°€ì™€ ì¦‰ì‹œ êµ¬ë§¤ê°€ëŠ” 1000ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                    return;
                }

                // âŒ ì¦‰ì‹œ êµ¬ë§¤ê°€ê°€ ì‹œì‘ê°€ë³´ë‹¤ ì‘ìœ¼ë©´ ì˜ˆì™¸ ì²˜ë¦¬
                if (parseInt(price) < parseInt(startPrice)) {
                    alert("ì¦‰ì‹œ êµ¬ë§¤ê°€ëŠ” ì‹œì‘ê°€ë³´ë‹¤ í¬ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.");
                    return;
                }

                // âŒ ë§ˆê° ì‹œê°„ ê²€ì¦ (í˜„ì¬ ì‹œê°„ ê¸°ì¤€ 24ì‹œê°„ í›„ë¶€í„° ì„¤ì • ê°€ëŠ¥)
                const now = new Date();
                const selectedClosingTime = new Date(`${auctionDate}T${String(auctionHour).padStart(2, '0')}:${String(auctionMinute).padStart(2, '0')}:00+09:00`);
                const minClosingTime = new Date(now.getTime() + 24 * 60 * 60 * 1000); // í˜„ì¬ ì‹œê°„ + 24ì‹œê°„
                const maxClosingTime = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000); // +7ì¼

                if (selectedClosingTime.getTime() <= minClosingTime.getTime()) {
                    alert("ë§ˆê° ì‹œê°„ì€ í˜„ì¬ ì‹œê°„ ê¸°ì¤€ 24ì‹œê°„ ì´í›„ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.");
                    return;
                }
                if (selectedClosingTime.getTime() > maxClosingTime.getTime()) {
                    alert("ë§ˆê° ì‹œê°„ì€ í˜„ì¬ ì‹œê°„ ê¸°ì¤€ 7ì¼ ì´ë‚´ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.");
                    return;
                }

                // âŒ ìµœì†Œ ì…ì°° ë‹¨ìœ„ ê²€ì¦: ì‹œì‘ê°€ ê¸°ì¤€ 10ë§Œì› ë¯¸ë§Œì€ 10% ì´í•˜, 10ë§Œì› ì´ìƒì€ 5% ì´í•˜
                const intStartPrice = parseInt(startPrice);
                if (minIncrement !== 100) {
                    if (intStartPrice < 100000) {
                        if (minIncrement > intStartPrice * 0.1) {
                            alert("ìµœì†Œ ì…ì°° ë‹¨ìœ„ëŠ” ì‹œì‘ê°€ì˜ 10% ì´í•˜ë¡œ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.\n(ì‹œì‘ê°€ ê¸°ì¤€ 10ë§Œì› ë¯¸ë§Œì€ 10% ì´í•˜)");
                            return;
                        }
                    } else {
                        if (minIncrement > intStartPrice * 0.05) {
                            alert("ìµœì†Œ ì…ì°° ë‹¨ìœ„ëŠ” ì‹œì‘ê°€ì˜ 5% ì´í•˜ë¡œ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.\n(ì‹œì‘ê°€ ê¸°ì¤€ 10ë§Œì› ì´ìƒì€ 5% ì´í•˜)");
                            return;
                        }
                    }
                }

                // ë“±ë¡ í™•ì¸ í›„ ì „ì†¡
                if (!confirm("ìƒí’ˆì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    return;
                }

                // í¼ ë°ì´í„° êµ¬ì„±
                const formData = {
                    categoryName: categoryName,
                    name: name,
                    description: description,
                    startPrice: parseInt(startPrice),
                    price: parseInt(price),
                    imageUrl: uploadedImageUrls,  // imageUrl í•„ë“œëŠ” S3 ì—…ë¡œë“œ í›„ ë°˜í™˜ë°›ì€ URLë“¤ ì‚¬ìš©
                    auctionDate: auctionDate,
                    auctionHour: parseInt(auctionHour),
                    auctionMinute: parseInt(auctionMinute),
                    minIncrement: minIncrement,
                    dealType: dealType
                };

                try {
                    const response = await fetch('/product/insert', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    if (response.ok) {
                        alert("ë¬¼í’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                        window.location.href = "/";
                    } else {
                        alert("ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        } else {
            console.error("ë“±ë¡ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        const cancelButton = document.querySelector(".cancel");
        if (cancelButton) {
            cancelButton.addEventListener("click", () => {
                window.location.href = "/";
            });
        }
    });
</script>


</body>
</html>

